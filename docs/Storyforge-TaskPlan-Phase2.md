# Storyforge Task Plan Phase 2 - AI í†µí•© ìƒì„¸ ì‘ì—… ëª…ì„¸ì„œ

> **ë¬¸ì„œ ë²„ì „**: 1.0
> **ì‘ì„±ì¼**: 2026-02-01
> **ì°¸ì¡° ë¬¸ì„œ**: `Storyforge-PRD.md`, `Storyforge-PRD-v2.md`, `Storyforge-TaskPlan.md`
> **ëª©ì **: AI ë³´ì¡°ì‘ê°€ ê¸°ëŠ¥ì˜ ì²´ê³„ì  êµ¬í˜„ì„ ìœ„í•œ ìƒì„¸ ëª…ì„¸

---

## ë¬¸ì„œ ì‚¬ìš© ê°€ì´ë“œ

### Phase 2 ê°œìš”

Phase 2ëŠ” Storyforgeì˜ í•µì‹¬ ì°¨ë³„í™” ê¸°ëŠ¥ì¸ **AI ë³´ì¡°ì‘ê°€**ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
ì°½ì‘ìê°€ AIì™€ ëŒ€í™”í•˜ë©° ì¤„ê±°ë¦¬ë¥¼ ì„¤ì •í•˜ê³ , ì¸ë¬¼ì„ êµ¬ì²´í™”í•˜ë©°, ì‹¤ì‹œê°„ìœ¼ë¡œ ì‘í’ˆ ë§¥ë½ì„ ìœ ì§€í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

### ì˜ì¡´ì„± ë‹¤ì´ì–´ê·¸ë¨

```
Phase 1 ì™„ë£Œ
    â”‚
    â”œâ”€â”€ TASK-P2-01 (AI íƒ€ì… ì •ì˜)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ TASK-P2-02 (AI ì„œë¹„ìŠ¤ ê¸°ë°˜)
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â”€ TASK-P2-03 (ë§¥ë½ ê´€ë¦¬)
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â””â”€â”€ TASK-P2-04 (AI ìŠ¤í† ì–´)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚  TASK-P2-05      TASK-P2-06
    â”‚       â”‚       â”‚  (ëŒ€í™”ì°½ UI)     (ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸)
    â”‚       â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-07 (ì¤„ê±°ë¦¬ ì„¤ì •)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-08 (ì¸ë¬¼ ì„¤ì •)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-09 (ì‹¤ì‹œê°„ ìš”ì•½)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-10 (í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-11 (ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-12 (í† í°/ë¹„ìš© ê´€ë¦¬)
    â”‚       â”‚       â”‚               â”‚
    â”‚       â”‚       â”‚       TASK-P2-13 (QA ë° ìµœì í™”)
    â”‚       â”‚       â”‚
    â”‚       â”‚       â””â”€â”€ TASK-P2-14 (API í‚¤ ê´€ë¦¬)
```

---

## Phase 2 í•µì‹¬ ì›ì¹™

### AI í†µí•© ì² í•™

> **"AIëŠ” ë³´ì¡°ì, ì‘ê°€ëŠ” ì°½ì‘ì"**

| ì›ì¹™ | ì„¤ëª… |
|------|------|
| ë§¥ë½ ìœ ì§€ | AIëŠ” í˜„ì¬ ì‘í’ˆì˜ ì„¤ì •, ì¸ë¬¼, ì¤„ê±°ë¦¬ë¥¼ í•­ìƒ ì¸ì§€ |
| ì‘ê°€ ì¤‘ì‹¬ | ëª¨ë“  AI ì œì•ˆì€ ì‘ê°€ì˜ ìŠ¹ì¸ì„ ê±°ì³ ë°˜ì˜ |
| íˆ¬ëª…ì„± | AI ì‚¬ìš©ëŸ‰ê³¼ ë¹„ìš©ì„ ëª…í™•íˆ í‘œì‹œ |
| ì˜¤í”„ë¼ì¸ ëŒ€ë¹„ | AI ë¶ˆê°€ì‹œì—ë„ ê¸°ë³¸ ê¸°ëŠ¥ì€ ì •ìƒ ì‘ë™ |

### ê¸°ìˆ  ì„ íƒ

| í•­ëª© | ì„ íƒ | ì´ìœ  |
|------|------|------|
| AI ëª¨ë¸ | OpenAI GPT-4 / GPT-3.5 | í•œêµ­ì–´ ì„±ëŠ¥, API ì•ˆì •ì„±, ë¹„ìš© íš¨ìœ¨ |
| ìŠ¤íŠ¸ë¦¬ë° | Server-Sent Events | ì‹¤ì‹œê°„ ì‘ë‹µ í‘œì‹œ |
| ë§¥ë½ ê´€ë¦¬ | ìŠ¬ë¼ì´ë”© ìœˆë„ìš° + ìš”ì•½ | í† í° íš¨ìœ¨ì„± |
| ìƒíƒœ ê´€ë¦¬ | Zustand | ê¸°ì¡´ íŒ¨í„´ ìœ ì§€ |

---

## Week 1: AI ê¸°ë°˜ êµ¬ì¶•

---

### TASK-P2-01: AI ê´€ë ¨ TypeScript íƒ€ì… ì •ì˜

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
AI ê¸°ëŠ¥ì— í•„ìš”í•œ ëª¨ë“  ë°ì´í„° êµ¬ì¡°ë¥¼ TypeScript íƒ€ì…ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤. ëŒ€í™” ë©”ì‹œì§€, AI ì„¤ì •, ë§¥ë½ ë°ì´í„°, ì‘ë‹µ êµ¬ì¡° ë“±ì„ í¬í•¨í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: Phase 1 ì™„ë£Œ

**ì‚°ì¶œë¬¼**:
- `src/types/ai.ts`
- `src/types/index.ts` (ì—…ë°ì´íŠ¸)

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

**1. AI íƒ€ì… ì •ì˜** (`src/types/ai.ts`)

```typescript
/**
 * AI ê´€ë ¨ íƒ€ì… ì •ì˜
 * Phase 2: AI ë³´ì¡°ì‘ê°€ ê¸°ëŠ¥
 */

// ============================================
// AI ì„¤ì • ë° ëª¨ë¸
// ============================================

/**
 * ì§€ì›í•˜ëŠ” AI ëª¨ë¸
 */
export type AIModel =
  | 'gpt-4'
  | 'gpt-4-turbo'
  | 'gpt-3.5-turbo';

/**
 * AI ì„œë¹„ìŠ¤ ì„¤ì •
 */
export interface AIConfig {
  model: AIModel;
  temperature: number;        // 0.0 ~ 2.0, ê¸°ë³¸ 0.7
  maxTokens: number;          // ì‘ë‹µ ìµœëŒ€ í† í°
  streamEnabled: boolean;     // ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”
}

/**
 * API í‚¤ ì„¤ì •
 */
export interface AIAPIConfig {
  provider: 'openai';
  apiKey: string;
  organizationId?: string;
}

// ============================================
// ëŒ€í™” ë©”ì‹œì§€
// ============================================

/**
 * ë©”ì‹œì§€ ì—­í• 
 */
export type MessageRole = 'user' | 'assistant' | 'system';

/**
 * ë©”ì‹œì§€ ìƒíƒœ
 */
export type MessageStatus =
  | 'sending'      // ì „ì†¡ ì¤‘
  | 'streaming'    // ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹  ì¤‘
  | 'complete'     // ì™„ë£Œ
  | 'error';       // ì˜¤ë¥˜

/**
 * ëŒ€í™” ë©”ì‹œì§€
 */
export interface ChatMessage {
  id: string;
  role: MessageRole;
  content: string;
  status: MessageStatus;

  // ë©”íƒ€ë°ì´í„°
  timestamp: Date;
  tokenCount?: number;        // í† í° ì‚¬ìš©ëŸ‰

  // AI ì‘ë‹µ ê´€ë ¨
  model?: AIModel;            // ì‚¬ìš©ëœ ëª¨ë¸
  finishReason?: 'stop' | 'length' | 'content_filter';

  // ì•¡ì…˜ ê´€ë ¨ (AIê°€ ì œì•ˆí•œ ì•¡ì…˜)
  suggestedActions?: SuggestedAction[];

  // ì—ëŸ¬ ì •ë³´
  error?: {
    code: string;
    message: string;
  };
}

/**
 * AIê°€ ì œì•ˆí•œ ì•¡ì…˜
 */
export interface SuggestedAction {
  id: string;
  type: ActionType;
  label: string;              // ë²„íŠ¼ì— í‘œì‹œë  í…ìŠ¤íŠ¸
  data: Record<string, unknown>;  // ì•¡ì…˜ ì‹¤í–‰ì— í•„ìš”í•œ ë°ì´í„°
  applied: boolean;           // ì ìš© ì—¬ë¶€
}

export type ActionType =
  | 'create_character'        // ì¸ë¬¼ ì¹´ë“œ ìƒì„±
  | 'update_character'        // ì¸ë¬¼ ì¹´ë“œ ìˆ˜ì •
  | 'create_location'         // ì¥ì†Œ ì¹´ë“œ ìƒì„±
  | 'create_item'             // ì•„ì´í…œ ì¹´ë“œ ìƒì„±
  | 'update_synopsis'         // ì‹œë†‰ì‹œìŠ¤ ì—…ë°ì´íŠ¸
  | 'create_chapter_outline'  // í™”ë³„ ì¤„ê±°ë¦¬ ìƒì„±
  | 'apply_to_editor'         // ì—ë””í„°ì— í…ìŠ¤íŠ¸ ì‚½ì…
  | 'save_to_notes';          // ë©”ëª¨ë¡œ ì €ì¥

// ============================================
// ëŒ€í™” ì„¸ì…˜
// ============================================

/**
 * ëŒ€í™” ì„¸ì…˜ íƒ€ì…
 */
export type ConversationType =
  | 'general'           // ì¼ë°˜ ëŒ€í™”
  | 'plot_setting'      // ì¤„ê±°ë¦¬ ì„¤ì •
  | 'character_setting' // ì¸ë¬¼ ì„¤ì •
  | 'writing_assist'    // ê¸€ì“°ê¸° ë³´ì¡°
  | 'world_building';   // ì„¸ê³„ê´€ êµ¬ì¶•

/**
 * ëŒ€í™” ì„¸ì…˜
 */
export interface ChatSession {
  id: string;
  projectId: string;
  type: ConversationType;
  title: string;              // ì„¸ì…˜ ì œëª©

  messages: ChatMessage[];

  // í†µê³„
  stats: {
    messageCount: number;
    totalTokens: number;
    estimatedCost: number;    // USD
  };

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Date;
  updatedAt: Date;
}

// ============================================
// ë§¥ë½ ê´€ë¦¬
// ============================================

/**
 * AIì—ê²Œ ì „ë‹¬ë˜ëŠ” í”„ë¡œì íŠ¸ ë§¥ë½
 */
export interface ProjectContext {
  // í”„ë¡œì íŠ¸ ê¸°ë³¸ ì •ë³´
  projectInfo: {
    title: string;
    description: string;
    genre: string[];
    targetPlatform?: string;
    targetLength?: number;
  };

  // í˜„ì¬ ì‘ì—… ìœ„ì¹˜
  currentPosition?: {
    volumeTitle: string;
    chapterTitle: string;
    sceneTitle: string;
  };

  // ìš”ì•½ëœ ì¤„ê±°ë¦¬
  synopsis?: string;

  // ì£¼ìš” ë“±ì¥ì¸ë¬¼ (ìš”ì•½)
  mainCharacters: CharacterSummary[];

  // ìµœê·¼ ë‚´ìš© ìš”ì•½
  recentSummary?: string;

  // í˜„ì¬ ì”¬ ë‚´ìš© (ì¼ë¶€)
  currentContent?: string;
}

/**
 * ì¸ë¬¼ ìš”ì•½ (ë§¥ë½ìš©)
 */
export interface CharacterSummary {
  name: string;
  role: string;               // ì£¼ì¸ê³µ, ì¡°ì—° ë“±
  description: string;        // í•œ ì¤„ ì„¤ëª…
  currentState?: string;      // í˜„ì¬ ìƒíƒœ (ë¶€ìƒ, ê°ì • ë“±)
}

/**
 * ë§¥ë½ í† í° ì˜ˆì‚°
 */
export interface ContextBudget {
  total: number;              // ì „ì²´ ì˜ˆì‚°
  system: number;             // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  context: number;            // í”„ë¡œì íŠ¸ ë§¥ë½
  history: number;            // ëŒ€í™” íˆìŠ¤í† ë¦¬
  response: number;           // ì‘ë‹µ ì—¬ìœ ë¶„
}

// ============================================
// ì¤„ê±°ë¦¬ ì„¤ì •
// ============================================

/**
 * ì¤„ê±°ë¦¬ ì„¤ì • ë‹¨ê³„
 */
export type PlotSettingStep =
  | 'genre_selection'     // ì¥ë¥´ ì„ íƒ
  | 'premise'             // ê¸°ë³¸ ì „ì œ
  | 'main_character'      // ì£¼ì¸ê³µ ì„¤ì •
  | 'conflict'            // ê°ˆë“± ìš”ì†Œ
  | 'world_setting'       // ì„¸ê³„ê´€
  | 'plot_structure'      // í”Œë¡¯ êµ¬ì¡°
  | 'chapter_outline'     // í™”ë³„ ì¤„ê±°ë¦¬
  | 'review';             // ê²€í†  ë° í™•ì •

/**
 * ì¤„ê±°ë¦¬ ì„¤ì • ìƒíƒœ
 */
export interface PlotSettingState {
  currentStep: PlotSettingStep;
  completedSteps: PlotSettingStep[];

  // ìˆ˜ì§‘ëœ ì •ë³´
  data: {
    genre?: string[];
    premise?: string;
    mainCharacter?: Partial<CharacterSummary>;
    conflict?: string;
    worldSetting?: string;
    plotStructure?: {
      beginning: string;
      middle: string;
      end: string;
    };
    chapterOutlines?: Array<{
      volumeNumber: number;
      chapterNumber: number;
      title: string;
      summary: string;
    }>;
  };
}

// ============================================
// ì¸ë¬¼ ì„¤ì •
// ============================================

/**
 * ì¸ë¬¼ ì„¤ì • ë‹¨ê³„
 */
export type CharacterSettingStep =
  | 'basic_info'          // ê¸°ë³¸ ì •ë³´
  | 'appearance'          // ì™¸ëª¨
  | 'personality'         // ì„±ê²©
  | 'background'          // ë°°ê²½
  | 'motivation'          // ë™ê¸°
  | 'relationships'       // ê´€ê³„
  | 'abilities'           // ëŠ¥ë ¥ (ì¥ë¥´ì— ë”°ë¼)
  | 'arc'                 // ì„±ì¥ ê³¡ì„ 
  | 'review';             // ê²€í†  ë° ìƒì„±

/**
 * ì¸ë¬¼ ì„¤ì • ìƒíƒœ
 */
export interface CharacterSettingState {
  currentStep: CharacterSettingStep;
  completedSteps: CharacterSettingStep[];
  targetCharacterId?: string;   // ê¸°ì¡´ ìºë¦­í„° ìˆ˜ì •ì‹œ

  // ìˆ˜ì§‘ ì¤‘ì¸ ë°ì´í„°
  data: Partial<{
    name: string;
    role: string;
    age: string;
    gender: string;
    occupation: string;
    appearance: string;
    personality: string;
    background: string;
    motivation: string;
    relationships: Array<{
      targetName: string;
      type: string;
      description: string;
    }>;
    abilities: Array<{
      name: string;
      description: string;
    }>;
    arc: Array<{
      phase: string;
      change: string;
    }>;
  }>;
}

// ============================================
// ì‹¤ì‹œê°„ ìš”ì•½
// ============================================

/**
 * ì‹¤ì‹œê°„ ìš”ì•½ íŒ¨ë„ ë°ì´í„°
 */
export interface RealtimeSummary {
  // í”„ë¡œì íŠ¸ ì „ì²´ ì§„í–‰ìƒí™©
  progress: {
    currentVolume: number;
    currentChapter: number;
    totalChapters: number;
    completionPercentage: number;
  };

  // ë“±ì¥ì¸ë¬¼ í˜„ì¬ ìƒíƒœ
  characterStates: Array<{
    characterId: string;
    name: string;
    location?: string;
    condition?: string;       // ê±´ê°•, ê°ì • ë“±
    lastAppearance?: string;  // ë§ˆì§€ë§‰ ë“±ì¥ ìœ„ì¹˜
  }>;

  // ìµœê·¼ í™” ìš”ì•½ (AI ì°¸ì¡°ìš©)
  recentChapterSummaries: Array<{
    chapterTitle: string;
    summary: string;
    keyEvents: string[];
  }>;

  // í™œì„± ë³µì„ 
  activeForeshadowing: Array<{
    id: string;
    description: string;
    introducedAt: string;     // ì–´ë””ì„œ ì†Œê°œëëŠ”ì§€
    resolved: boolean;
  }>;

  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
  lastUpdatedAt: Date;
}

// ============================================
// í† í° ë° ë¹„ìš© ê´€ë¦¬
// ============================================

/**
 * í† í° ì‚¬ìš©ëŸ‰ ê¸°ë¡
 */
export interface TokenUsage {
  id: string;
  projectId: string;
  sessionId: string;

  model: AIModel;
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;

  estimatedCost: number;      // USD

  createdAt: Date;
}

/**
 * ì¼ì¼ ì‚¬ìš©ëŸ‰ ìš”ì•½
 */
export interface DailyUsageSummary {
  date: string;               // YYYY-MM-DD
  totalTokens: number;
  totalCost: number;
  requestCount: number;
  byModel: Record<AIModel, {
    tokens: number;
    cost: number;
    requests: number;
  }>;
}

/**
 * ì‚¬ìš©ëŸ‰ ì œí•œ ì„¤ì •
 */
export interface UsageLimits {
  dailyTokenLimit?: number;
  dailyCostLimit?: number;    // USD
  warningThreshold: number;   // 0.0 ~ 1.0, ê¸°ë³¸ 0.8
}

// ============================================
// API ì‘ë‹µ íƒ€ì…
// ============================================

/**
 * OpenAI Chat Completion ì‘ë‹µ (ê°„ì†Œí™”)
 */
export interface ChatCompletionResponse {
  id: string;
  choices: Array<{
    index: number;
    message: {
      role: 'assistant';
      content: string;
    };
    finish_reason: 'stop' | 'length' | 'content_filter';
  }>;
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

/**
 * ìŠ¤íŠ¸ë¦¬ë° ì²­í¬
 */
export interface StreamChunk {
  id: string;
  choices: Array<{
    index: number;
    delta: {
      content?: string;
    };
    finish_reason: 'stop' | 'length' | 'content_filter' | null;
  }>;
}
```

**2. íƒ€ì… ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸** (`src/types/index.ts`)

```typescript
// ê¸°ì¡´ export ìœ ì§€
export * from './project';
export * from './document';
export * from './worldbuilding';
export * from './common';

// Phase 2: AI íƒ€ì… ì¶”ê°€
export * from './ai';
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] `src/types/ai.ts` íŒŒì¼ ìƒì„± ì™„ë£Œ
- [ ] TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ ì—†ìŒ
- [ ] `import type { ChatMessage, AIConfig } from '@/types'` í˜•íƒœë¡œ import ê°€ëŠ¥
- [ ] ëª¨ë“  íƒ€ì…ì— JSDoc ì£¼ì„ í¬í•¨

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```typescript
import type {
  ChatMessage,
  ChatSession,
  ProjectContext,
  PlotSettingState
} from '@/types';

// íƒ€ì… ì‚¬ìš© í…ŒìŠ¤íŠ¸
const message: ChatMessage = {
  id: 'test-1',
  role: 'user',
  content: 'ì£¼ì¸ê³µ ì´ë¦„ì„ ì •í•´ì¤˜',
  status: 'complete',
  timestamp: new Date(),
};

// IDE ìë™ì™„ì„± ë™ì‘ í™•ì¸
```

---

### TASK-P2-02: AI ì„œë¹„ìŠ¤ ê¸°ë°˜ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
OpenAI APIì™€ í†µì‹ í•˜ëŠ” ê¸°ë³¸ ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. API í˜¸ì¶œ, ì—ëŸ¬ í•¸ë“¤ë§, ìŠ¤íŠ¸ë¦¬ë° ê¸°ë°˜ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-01

**ì‚°ì¶œë¬¼**:
- `src/services/ai/openaiClient.ts`
- `src/services/ai/index.ts`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

**1. OpenAI í´ë¼ì´ì–¸íŠ¸** (`src/services/ai/openaiClient.ts`)

```typescript
/**
 * OpenAI API í´ë¼ì´ì–¸íŠ¸
 *
 * ê¸°ëŠ¥:
 * - Chat Completion API í˜¸ì¶œ
 * - ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
 * - ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì‹œë„
 * - í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 
 */

import type {
  AIConfig,
  AIModel,
  ChatMessage,
  ChatCompletionResponse,
  StreamChunk,
  TokenUsage
} from '@/types';
import { generateId } from '@/lib/id';

// API ì—”ë“œí¬ì¸íŠ¸
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

// ëª¨ë¸ë³„ í† í° ë¹„ìš© (USD per 1K tokens, 2024ë…„ ê¸°ì¤€)
const TOKEN_COSTS: Record<AIModel, { input: number; output: number }> = {
  'gpt-4': { input: 0.03, output: 0.06 },
  'gpt-4-turbo': { input: 0.01, output: 0.03 },
  'gpt-3.5-turbo': { input: 0.0005, output: 0.0015 },
};

// ê¸°ë³¸ ì„¤ì •
const DEFAULT_CONFIG: AIConfig = {
  model: 'gpt-3.5-turbo',
  temperature: 0.7,
  maxTokens: 2000,
  streamEnabled: true,
};

/**
 * OpenAI API ì—ëŸ¬ íƒ€ì…
 */
export class OpenAIError extends Error {
  constructor(
    message: string,
    public code: string,
    public status?: number
  ) {
    super(message);
    this.name = 'OpenAIError';
  }
}

/**
 * API í‚¤ ê°€ì ¸ì˜¤ê¸°
 * localStorageì—ì„œ ì•”í˜¸í™”ëœ í‚¤ë¥¼ ê°€ì ¸ì˜´
 */
function getAPIKey(): string {
  const key = localStorage.getItem('storyforge-openai-key');
  if (!key) {
    throw new OpenAIError('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'NO_API_KEY');
  }
  // ì‹¤ì œë¡œëŠ” ì•”í˜¸í™”/ë³µí˜¸í™” ë¡œì§ í•„ìš”
  return key;
}

/**
 * ë©”ì‹œì§€ë¥¼ OpenAI í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 */
function formatMessages(
  messages: ChatMessage[],
  systemPrompt?: string
): Array<{ role: string; content: string }> {
  const formatted: Array<{ role: string; content: string }> = [];

  if (systemPrompt) {
    formatted.push({ role: 'system', content: systemPrompt });
  }

  for (const msg of messages) {
    if (msg.status === 'complete' || msg.status === 'streaming') {
      formatted.push({
        role: msg.role,
        content: msg.content,
      });
    }
  }

  return formatted;
}

/**
 * í† í° ë¹„ìš© ê³„ì‚°
 */
export function calculateCost(
  model: AIModel,
  promptTokens: number,
  completionTokens: number
): number {
  const costs = TOKEN_COSTS[model];
  const inputCost = (promptTokens / 1000) * costs.input;
  const outputCost = (completionTokens / 1000) * costs.output;
  return inputCost + outputCost;
}

/**
 * Chat Completion API í˜¸ì¶œ (ì¼ë°˜)
 */
export async function chatCompletion(
  messages: ChatMessage[],
  systemPrompt?: string,
  config: Partial<AIConfig> = {}
): Promise<{
  message: ChatMessage;
  usage: TokenUsage;
}> {
  const apiKey = getAPIKey();
  const finalConfig = { ...DEFAULT_CONFIG, ...config };

  const formattedMessages = formatMessages(messages, systemPrompt);

  const response = await fetch(OPENAI_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: finalConfig.model,
      messages: formattedMessages,
      temperature: finalConfig.temperature,
      max_tokens: finalConfig.maxTokens,
      stream: false,
    }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new OpenAIError(
      error.error?.message || 'API ìš”ì²­ ì‹¤íŒ¨',
      error.error?.code || 'API_ERROR',
      response.status
    );
  }

  const data: ChatCompletionResponse = await response.json();
  const choice = data.choices[0];

  const assistantMessage: ChatMessage = {
    id: generateId(),
    role: 'assistant',
    content: choice.message.content,
    status: 'complete',
    timestamp: new Date(),
    model: finalConfig.model,
    finishReason: choice.finish_reason,
    tokenCount: data.usage.completion_tokens,
  };

  const usage: TokenUsage = {
    id: generateId(),
    projectId: '', // í˜¸ì¶œìê°€ ì„¤ì •
    sessionId: '', // í˜¸ì¶œìê°€ ì„¤ì •
    model: finalConfig.model,
    promptTokens: data.usage.prompt_tokens,
    completionTokens: data.usage.completion_tokens,
    totalTokens: data.usage.total_tokens,
    estimatedCost: calculateCost(
      finalConfig.model,
      data.usage.prompt_tokens,
      data.usage.completion_tokens
    ),
    createdAt: new Date(),
  };

  return { message: assistantMessage, usage };
}

/**
 * ìŠ¤íŠ¸ë¦¬ë° Chat Completion
 *
 * @param onChunk - ê° ì²­í¬ ìˆ˜ì‹ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±
 * @param onComplete - ì™„ë£Œì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±
 * @param onError - ì—ëŸ¬ ë°œìƒì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±
 */
export async function chatCompletionStream(
  messages: ChatMessage[],
  systemPrompt: string | undefined,
  config: Partial<AIConfig>,
  callbacks: {
    onChunk: (content: string) => void;
    onComplete: (message: ChatMessage) => void;
    onError: (error: OpenAIError) => void;
  }
): Promise<AbortController> {
  const apiKey = getAPIKey();
  const finalConfig = { ...DEFAULT_CONFIG, ...config };
  const formattedMessages = formatMessages(messages, systemPrompt);

  const abortController = new AbortController();

  try {
    const response = await fetch(OPENAI_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: finalConfig.model,
        messages: formattedMessages,
        temperature: finalConfig.temperature,
        max_tokens: finalConfig.maxTokens,
        stream: true,
      }),
      signal: abortController.signal,
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new OpenAIError(
        error.error?.message || 'API ìš”ì²­ ì‹¤íŒ¨',
        error.error?.code || 'API_ERROR',
        response.status
      );
    }

    const reader = response.body?.getReader();
    if (!reader) {
      throw new OpenAIError('ìŠ¤íŠ¸ë¦¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'STREAM_ERROR');
    }

    const decoder = new TextDecoder();
    let fullContent = '';
    let finishReason: ChatMessage['finishReason'];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n').filter(line => line.trim() !== '');

      for (const line of lines) {
        if (line === 'data: [DONE]') continue;
        if (!line.startsWith('data: ')) continue;

        try {
          const json: StreamChunk = JSON.parse(line.slice(6));
          const delta = json.choices[0]?.delta?.content;

          if (delta) {
            fullContent += delta;
            callbacks.onChunk(delta);
          }

          if (json.choices[0]?.finish_reason) {
            finishReason = json.choices[0].finish_reason;
          }
        } catch {
          // íŒŒì‹± ì—ëŸ¬ ë¬´ì‹œ
        }
      }
    }

    const completeMessage: ChatMessage = {
      id: generateId(),
      role: 'assistant',
      content: fullContent,
      status: 'complete',
      timestamp: new Date(),
      model: finalConfig.model,
      finishReason,
    };

    callbacks.onComplete(completeMessage);
  } catch (error) {
    if (error instanceof OpenAIError) {
      callbacks.onError(error);
    } else if ((error as Error).name === 'AbortError') {
      // ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨
      callbacks.onError(new OpenAIError('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ABORTED'));
    } else {
      callbacks.onError(new OpenAIError(
        (error as Error).message,
        'UNKNOWN_ERROR'
      ));
    }
  }

  return abortController;
}

/**
 * API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
 */
export async function validateAPIKey(apiKey: string): Promise<boolean> {
  try {
    const response = await fetch('https://api.openai.com/v1/models', {
      headers: {
        'Authorization': `Bearer ${apiKey}`,
      },
    });
    return response.ok;
  } catch {
    return false;
  }
}
```

**2. AI ì„œë¹„ìŠ¤ ì¸ë±ìŠ¤** (`src/services/ai/index.ts`)

```typescript
export {
  chatCompletion,
  chatCompletionStream,
  validateAPIKey,
  calculateCost,
  OpenAIError,
} from './openaiClient';
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] OpenAI API í˜¸ì¶œ ì •ìƒ ë™ì‘
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬ ê°€ëŠ¥
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ë™ì‘ (API í‚¤ ì—†ìŒ, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±)
- [ ] TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ ì—†ìŒ

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```typescript
// API í‚¤ ìœ íš¨ì„± ê²€ì‚¬ í…ŒìŠ¤íŠ¸
const isValid = await validateAPIKey('sk-...');
console.log('API Key Valid:', isValid);

// ì¼ë°˜ ì‘ë‹µ í…ŒìŠ¤íŠ¸
const { message, usage } = await chatCompletion(
  [{ id: '1', role: 'user', content: 'ì•ˆë…•', status: 'complete', timestamp: new Date() }],
  'ë‹¹ì‹ ì€ ì¹œì ˆí•œ AI ë¹„ì„œì…ë‹ˆë‹¤.',
  { model: 'gpt-3.5-turbo' }
);
console.log('Response:', message.content);
console.log('Tokens:', usage.totalTokens);
```

---

### TASK-P2-03: ë§¥ë½ ê´€ë¦¬ ì„œë¹„ìŠ¤ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
AIê°€ ì‘í’ˆì˜ ë§¥ë½ì„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ í”„ë¡œì íŠ¸ ì •ë³´, ì¸ë¬¼ ì •ë³´, ìµœê·¼ ë‚´ìš©ì„ ìˆ˜ì§‘í•˜ê³  í† í° ì˜ˆì‚° ë‚´ì—ì„œ ìµœì í™”í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-01, TASK-P2-02

**ì‚°ì¶œë¬¼**:
- `src/services/ai/contextManager.ts`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * ë§¥ë½ ê´€ë¦¬ ì„œë¹„ìŠ¤
 *
 * ê¸°ëŠ¥:
 * - í”„ë¡œì íŠ¸ ì •ë³´ ìˆ˜ì§‘ ë° ìš”ì•½
 * - ì¸ë¬¼ ì •ë³´ ìš”ì•½
 * - ìµœê·¼ ë‚´ìš© ì¶”ì¶œ
 * - í† í° ì˜ˆì‚° ê´€ë¦¬
 */

import { db } from '@/db';
import type {
  ProjectContext,
  CharacterSummary,
  ContextBudget,
  CharacterCard,
  Project,
  Scene,
  Volume,
  Chapter
} from '@/types';

// ê¸°ë³¸ í† í° ì˜ˆì‚° (GPT-4 ê¸°ì¤€ 8K ì»¨í…ìŠ¤íŠ¸)
const DEFAULT_BUDGET: ContextBudget = {
  total: 6000,        // ì „ì²´ ì˜ˆì‚° (ì‘ë‹µ ì—¬ìœ ë¶„ ì œì™¸)
  system: 500,        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  context: 2000,      // í”„ë¡œì íŠ¸ ë§¥ë½
  history: 2500,      // ëŒ€í™” íˆìŠ¤í† ë¦¬
  response: 1000,     // ì‘ë‹µ ì˜ˆì•½
};

/**
 * í† í° ìˆ˜ ì¶”ì • (ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)
 * í•œêµ­ì–´ëŠ” ëŒ€ëµ 1.5~2 í† í°/ê¸€ì
 */
export function estimateTokens(text: string): number {
  // í•œê¸€: ëŒ€ëµ 2í† í°/ê¸€ì, ì˜ì–´: ëŒ€ëµ 0.25í† í°/ë‹¨ì–´
  const koreanChars = (text.match(/[ê°€-í£]/g) || []).length;
  const otherChars = text.length - koreanChars;
  return Math.ceil(koreanChars * 2 + otherChars * 0.5);
}

/**
 * í…ìŠ¤íŠ¸ë¥¼ í† í° ì˜ˆì‚° ë‚´ë¡œ ìë¥´ê¸°
 */
export function truncateToTokenBudget(text: string, budget: number): string {
  const estimated = estimateTokens(text);
  if (estimated <= budget) return text;

  // ëŒ€ëµì ì¸ ë¹„ìœ¨ë¡œ ìë¥´ê¸°
  const ratio = budget / estimated;
  const targetLength = Math.floor(text.length * ratio * 0.9); // 10% ì—¬ìœ 
  return text.slice(0, targetLength) + '...';
}

/**
 * ì¸ë¬¼ ì¹´ë“œë¥¼ ìš”ì•½ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 */
function summarizeCharacter(char: CharacterCard): CharacterSummary {
  const roleLabels = {
    protagonist: 'ì£¼ì¸ê³µ',
    antagonist: 'ì•…ì—­',
    supporting: 'ì¡°ì—°',
    minor: 'ë‹¨ì—­',
  };

  let description = '';
  if (char.basicInfo.age) description += `${char.basicInfo.age}, `;
  if (char.basicInfo.occupation) description += `${char.basicInfo.occupation}, `;
  if (char.personality) description += char.personality.slice(0, 50);

  return {
    name: char.name,
    role: roleLabels[char.role] || char.role,
    description: description.trim().replace(/,\s*$/, '') || char.description.slice(0, 100),
  };
}

/**
 * í”„ë¡œì íŠ¸ ë§¥ë½ ìˆ˜ì§‘
 */
export async function buildProjectContext(
  projectId: string,
  currentSceneId?: string,
  budget: ContextBudget = DEFAULT_BUDGET
): Promise<ProjectContext> {
  // í”„ë¡œì íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const project = await db.projects.get(projectId);
  if (!project) throw new Error('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  // ëª¨ë“  ì¸ë¬¼ ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
  const characters = await db.characters
    .where('projectId')
    .equals(projectId)
    .toArray();

  // ì£¼ìš” ì¸ë¬¼ë§Œ (ì£¼ì¸ê³µ, ì•…ì—­, ì¡°ì—°)
  const mainCharacters = characters
    .filter(c => c.role !== 'minor')
    .slice(0, 10) // ìµœëŒ€ 10ëª…
    .map(summarizeCharacter);

  // í˜„ì¬ ìœ„ì¹˜ ì •ë³´
  let currentPosition: ProjectContext['currentPosition'];
  let currentContent: string | undefined;

  if (currentSceneId) {
    const scene = await db.scenes.get(currentSceneId);
    if (scene) {
      const chapter = await db.chapters.get(scene.chapterId);
      const volume = chapter ? await db.volumes.get(chapter.volumeId) : null;

      currentPosition = {
        volumeTitle: volume?.title || '',
        chapterTitle: chapter?.title || '',
        sceneTitle: scene.title,
      };

      // í˜„ì¬ ì”¬ ë‚´ìš© (ì¼ë¶€)
      currentContent = truncateToTokenBudget(
        scene.plainText,
        Math.floor(budget.context * 0.3)
      );
    }
  }

  // ë§¥ë½ ì¡°ë¦½
  const context: ProjectContext = {
    projectInfo: {
      title: project.title,
      description: project.description,
      genre: project.genre,
      targetPlatform: project.targetPlatform,
      targetLength: project.targetLength,
    },
    currentPosition,
    mainCharacters,
    currentContent,
  };

  return context;
}

/**
 * ë§¥ë½ì„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œ í¬ë§·íŒ…
 */
export function formatContextAsSystemPrompt(context: ProjectContext): string {
  const parts: string[] = [];

  // í”„ë¡œì íŠ¸ ì •ë³´
  parts.push(`## ì‘í’ˆ ì •ë³´`);
  parts.push(`- ì œëª©: ${context.projectInfo.title}`);
  if (context.projectInfo.description) {
    parts.push(`- ì„¤ëª…: ${context.projectInfo.description}`);
  }
  if (context.projectInfo.genre.length > 0) {
    parts.push(`- ì¥ë¥´: ${context.projectInfo.genre.join(', ')}`);
  }
  if (context.projectInfo.targetLength) {
    parts.push(`- ëª©í‘œ ë¶„ëŸ‰: ${context.projectInfo.targetLength}ì/í™”`);
  }

  // í˜„ì¬ ìœ„ì¹˜
  if (context.currentPosition) {
    parts.push('');
    parts.push(`## í˜„ì¬ ì‘ì—… ìœ„ì¹˜`);
    parts.push(`${context.currentPosition.volumeTitle} > ${context.currentPosition.chapterTitle} > ${context.currentPosition.sceneTitle}`);
  }

  // ì£¼ìš” ë“±ì¥ì¸ë¬¼
  if (context.mainCharacters.length > 0) {
    parts.push('');
    parts.push(`## ì£¼ìš” ë“±ì¥ì¸ë¬¼`);
    for (const char of context.mainCharacters) {
      parts.push(`- **${char.name}** (${char.role}): ${char.description}`);
    }
  }

  // ì‹œë†‰ì‹œìŠ¤
  if (context.synopsis) {
    parts.push('');
    parts.push(`## ì¤„ê±°ë¦¬ ìš”ì•½`);
    parts.push(context.synopsis);
  }

  // ìµœê·¼ ë‚´ìš©
  if (context.currentContent) {
    parts.push('');
    parts.push(`## í˜„ì¬ ì”¬ ë‚´ìš©`);
    parts.push(context.currentContent);
  }

  return parts.join('\n');
}

/**
 * ëŒ€í™” íˆìŠ¤í† ë¦¬ í† í° ìµœì í™”
 * ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„° ì œê±°í•˜ì—¬ ì˜ˆì‚° ë‚´ë¡œ ë§ì¶¤
 */
export function optimizeHistoryForTokenBudget(
  messages: Array<{ role: string; content: string }>,
  budget: number
): Array<{ role: string; content: string }> {
  let totalTokens = 0;
  const optimized: Array<{ role: string; content: string }> = [];

  // ìµœì‹  ë©”ì‹œì§€ë¶€í„° ì¶”ê°€
  for (let i = messages.length - 1; i >= 0; i--) {
    const msg = messages[i];
    const tokens = estimateTokens(msg.content);

    if (totalTokens + tokens > budget) {
      // ì˜ˆì‚° ì´ˆê³¼, ì—¬ê¸°ì„œ ì¤‘ë‹¨
      break;
    }

    optimized.unshift(msg);
    totalTokens += tokens;
  }

  return optimized;
}

/**
 * í”„ë¡œì íŠ¸ì˜ ìµœê·¼ ìš”ì•½ ìƒì„± (AI í˜¸ì¶œ ì—†ì´ ë‹¨ìˆœ ì¶”ì¶œ)
 */
export async function getRecentContentSummary(
  projectId: string,
  limit: number = 3
): Promise<string> {
  // ìµœê·¼ ìˆ˜ì •ëœ ì”¬ ê°€ì ¸ì˜¤ê¸°
  const recentScenes = await db.scenes
    .where('projectId')
    .equals(projectId)
    .reverse()
    .sortBy('updatedAt');

  const scenes = recentScenes.slice(0, limit);

  if (scenes.length === 0) {
    return 'ì•„ì§ ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
  }

  const summaries: string[] = [];

  for (const scene of scenes) {
    const chapter = await db.chapters.get(scene.chapterId);
    const preview = scene.plainText.slice(0, 200);
    summaries.push(`[${chapter?.title || ''}/${scene.title}] ${preview}...`);
  }

  return summaries.join('\n\n');
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] í”„ë¡œì íŠ¸ ë§¥ë½ ìˆ˜ì§‘ ì •ìƒ ë™ì‘
- [ ] í† í° ì˜ˆì‚° ë‚´ ìµœì í™” ë™ì‘
- [ ] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í¬ë§·íŒ… ì •ìƒ
- [ ] TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ ì—†ìŒ

---

### TASK-P2-04: AI Zustand ìŠ¤í† ì–´ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
AI ëŒ€í™” ìƒíƒœ, ì„¸ì…˜ ê´€ë¦¬, ì‚¬ìš©ëŸ‰ ì¶”ì ì„ ë‹´ë‹¹í•˜ëŠ” Zustand ìŠ¤í† ì–´ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-01, TASK-P2-02, TASK-P2-03

**ì‚°ì¶œë¬¼**:
- `src/stores/useAIStore.ts`
- `src/stores/index.ts` (ì—…ë°ì´íŠ¸)

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * AI ìŠ¤í† ì–´
 *
 * ê´€ë¦¬ í•­ëª©:
 * - í˜„ì¬ ëŒ€í™” ì„¸ì…˜
 * - ë©”ì‹œì§€ ëª©ë¡
 * - ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ
 * - í† í° ì‚¬ìš©ëŸ‰
 * - AI ì„¤ì •
 */

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { db } from '@/db';
import { generateId } from '@/lib/id';
import {
  chatCompletion,
  chatCompletionStream,
  OpenAIError
} from '@/services/ai';
import {
  buildProjectContext,
  formatContextAsSystemPrompt
} from '@/services/ai/contextManager';
import type {
  ChatMessage,
  ChatSession,
  ConversationType,
  AIConfig,
  AIModel,
  TokenUsage,
  UsageLimits,
  PlotSettingState,
  CharacterSettingState,
} from '@/types';

interface AIState {
  // í˜„ì¬ ì„¸ì…˜
  currentSession: ChatSession | null;
  sessions: Map<string, ChatSession>;

  // ë©”ì‹œì§€ ìƒíƒœ
  isGenerating: boolean;
  streamingContent: string;
  abortController: AbortController | null;

  // AI ì„¤ì •
  config: AIConfig;
  apiKeySet: boolean;

  // ì‚¬ìš©ëŸ‰
  todayUsage: {
    tokens: number;
    cost: number;
    requests: number;
  };
  usageLimits: UsageLimits;

  // íŠ¹ìˆ˜ ëª¨ë“œ ìƒíƒœ
  plotSettingState: PlotSettingState | null;
  characterSettingState: CharacterSettingState | null;

  // ì•¡ì…˜ - ì„¸ì…˜ ê´€ë¦¬
  createSession: (projectId: string, type: ConversationType) => Promise<string>;
  loadSession: (sessionId: string) => Promise<void>;
  closeSession: () => void;
  deleteSession: (sessionId: string) => Promise<void>;

  // ì•¡ì…˜ - ë©”ì‹œì§€
  sendMessage: (content: string, projectId: string, sceneId?: string) => Promise<void>;
  cancelGeneration: () => void;
  clearMessages: () => void;

  // ì•¡ì…˜ - ì„¤ì •
  setConfig: (config: Partial<AIConfig>) => void;
  setAPIKey: (key: string) => Promise<boolean>;
  clearAPIKey: () => void;
  setUsageLimits: (limits: Partial<UsageLimits>) => void;

  // ì•¡ì…˜ - íŠ¹ìˆ˜ ëª¨ë“œ
  startPlotSetting: (projectId: string) => void;
  updatePlotSettingState: (state: Partial<PlotSettingState>) => void;
  completePlotSetting: () => Promise<void>;

  startCharacterSetting: (projectId: string, characterId?: string) => void;
  updateCharacterSettingState: (state: Partial<CharacterSettingState>) => void;
  completeCharacterSetting: () => Promise<void>;

  // ì…€ë ‰í„°
  getSessionsByProject: (projectId: string) => ChatSession[];
  isOverUsageLimit: () => boolean;
}

const DEFAULT_CONFIG: AIConfig = {
  model: 'gpt-3.5-turbo',
  temperature: 0.7,
  maxTokens: 2000,
  streamEnabled: true,
};

const DEFAULT_USAGE_LIMITS: UsageLimits = {
  dailyTokenLimit: 100000,
  dailyCostLimit: 5.0,
  warningThreshold: 0.8,
};

export const useAIStore = create<AIState>()(
  persist(
    (set, get) => ({
      currentSession: null,
      sessions: new Map(),
      isGenerating: false,
      streamingContent: '',
      abortController: null,
      config: DEFAULT_CONFIG,
      apiKeySet: !!localStorage.getItem('storyforge-openai-key'),
      todayUsage: { tokens: 0, cost: 0, requests: 0 },
      usageLimits: DEFAULT_USAGE_LIMITS,
      plotSettingState: null,
      characterSettingState: null,

      createSession: async (projectId, type) => {
        const id = generateId();
        const now = new Date();

        const session: ChatSession = {
          id,
          projectId,
          type,
          title: getSessionTitle(type),
          messages: [],
          stats: {
            messageCount: 0,
            totalTokens: 0,
            estimatedCost: 0,
          },
          createdAt: now,
          updatedAt: now,
        };

        set(state => ({
          sessions: new Map(state.sessions).set(id, session),
          currentSession: session,
        }));

        return id;
      },

      loadSession: async (sessionId) => {
        const session = get().sessions.get(sessionId);
        if (session) {
          set({ currentSession: session });
        }
      },

      closeSession: () => {
        set({ currentSession: null });
      },

      deleteSession: async (sessionId) => {
        set(state => {
          const newSessions = new Map(state.sessions);
          newSessions.delete(sessionId);
          return {
            sessions: newSessions,
            currentSession: state.currentSession?.id === sessionId
              ? null
              : state.currentSession,
          };
        });
      },

      sendMessage: async (content, projectId, sceneId) => {
        const { currentSession, config, todayUsage, usageLimits } = get();

        // ì‚¬ìš©ëŸ‰ ì œí•œ ì²´í¬
        if (get().isOverUsageLimit()) {
          throw new Error('ì¼ì¼ ì‚¬ìš©ëŸ‰ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        const userMessage: ChatMessage = {
          id: generateId(),
          role: 'user',
          content,
          status: 'complete',
          timestamp: new Date(),
        };

        // AI ì‘ë‹µ í”Œë ˆì´ìŠ¤í™€ë”
        const assistantMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content: '',
          status: 'streaming',
          timestamp: new Date(),
        };

        // ì„¸ì…˜ ì—…ë°ì´íŠ¸
        const updatedMessages = [
          ...(currentSession?.messages || []),
          userMessage,
          assistantMessage,
        ];

        set(state => ({
          currentSession: state.currentSession
            ? { ...state.currentSession, messages: updatedMessages }
            : null,
          isGenerating: true,
          streamingContent: '',
        }));

        try {
          // ë§¥ë½ êµ¬ì¶•
          const context = await buildProjectContext(projectId, sceneId);
          const systemPrompt = getSystemPromptForType(
            currentSession?.type || 'general',
            context
          );

          if (config.streamEnabled) {
            // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
            const abortController = await chatCompletionStream(
              updatedMessages.slice(0, -1), // assistant placeholder ì œì™¸
              systemPrompt,
              config,
              {
                onChunk: (chunk) => {
                  set(state => ({
                    streamingContent: state.streamingContent + chunk,
                  }));
                },
                onComplete: (message) => {
                  set(state => {
                    const messages = state.currentSession?.messages || [];
                    const lastIdx = messages.length - 1;
                    messages[lastIdx] = message;

                    return {
                      currentSession: state.currentSession
                        ? {
                            ...state.currentSession,
                            messages: [...messages],
                            stats: {
                              ...state.currentSession.stats,
                              messageCount: messages.length,
                            },
                          }
                        : null,
                      isGenerating: false,
                      streamingContent: '',
                      abortController: null,
                    };
                  });
                },
                onError: (error) => {
                  set(state => {
                    const messages = state.currentSession?.messages || [];
                    const lastIdx = messages.length - 1;
                    messages[lastIdx] = {
                      ...messages[lastIdx],
                      status: 'error',
                      error: { code: error.code, message: error.message },
                    };

                    return {
                      currentSession: state.currentSession
                        ? { ...state.currentSession, messages: [...messages] }
                        : null,
                      isGenerating: false,
                      streamingContent: '',
                      abortController: null,
                    };
                  });
                },
              }
            );

            set({ abortController });
          } else {
            // ì¼ë°˜ ëª¨ë“œ
            const { message, usage } = await chatCompletion(
              updatedMessages.slice(0, -1),
              systemPrompt,
              config
            );

            // ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
            set(state => ({
              currentSession: state.currentSession
                ? {
                    ...state.currentSession,
                    messages: [
                      ...state.currentSession.messages.slice(0, -1),
                      message,
                    ],
                    stats: {
                      messageCount: state.currentSession.messages.length,
                      totalTokens: state.currentSession.stats.totalTokens + usage.totalTokens,
                      estimatedCost: state.currentSession.stats.estimatedCost + usage.estimatedCost,
                    },
                  }
                : null,
              isGenerating: false,
              todayUsage: {
                tokens: state.todayUsage.tokens + usage.totalTokens,
                cost: state.todayUsage.cost + usage.estimatedCost,
                requests: state.todayUsage.requests + 1,
              },
            }));
          }
        } catch (error) {
          set(state => {
            const messages = state.currentSession?.messages || [];
            const lastIdx = messages.length - 1;
            if (lastIdx >= 0) {
              messages[lastIdx] = {
                ...messages[lastIdx],
                status: 'error',
                error: {
                  code: 'SEND_ERROR',
                  message: (error as Error).message,
                },
              };
            }

            return {
              currentSession: state.currentSession
                ? { ...state.currentSession, messages: [...messages] }
                : null,
              isGenerating: false,
              streamingContent: '',
            };
          });
        }
      },

      cancelGeneration: () => {
        const { abortController } = get();
        if (abortController) {
          abortController.abort();
        }
        set({ isGenerating: false, streamingContent: '', abortController: null });
      },

      clearMessages: () => {
        set(state => ({
          currentSession: state.currentSession
            ? {
                ...state.currentSession,
                messages: [],
                stats: { messageCount: 0, totalTokens: 0, estimatedCost: 0 },
              }
            : null,
        }));
      },

      setConfig: (newConfig) => {
        set(state => ({
          config: { ...state.config, ...newConfig },
        }));
      },

      setAPIKey: async (key) => {
        const { validateAPIKey } = await import('@/services/ai');
        const isValid = await validateAPIKey(key);

        if (isValid) {
          localStorage.setItem('storyforge-openai-key', key);
          set({ apiKeySet: true });
        }

        return isValid;
      },

      clearAPIKey: () => {
        localStorage.removeItem('storyforge-openai-key');
        set({ apiKeySet: false });
      },

      setUsageLimits: (limits) => {
        set(state => ({
          usageLimits: { ...state.usageLimits, ...limits },
        }));
      },

      startPlotSetting: (projectId) => {
        set({
          plotSettingState: {
            currentStep: 'genre_selection',
            completedSteps: [],
            data: {},
          },
        });
      },

      updatePlotSettingState: (state) => {
        set(prev => ({
          plotSettingState: prev.plotSettingState
            ? { ...prev.plotSettingState, ...state }
            : null,
        }));
      },

      completePlotSetting: async () => {
        // TODO: ì¤„ê±°ë¦¬ ì„¤ì • ê²°ê³¼ë¥¼ í”„ë¡œì íŠ¸ì— ì €ì¥
        set({ plotSettingState: null });
      },

      startCharacterSetting: (projectId, characterId) => {
        set({
          characterSettingState: {
            currentStep: 'basic_info',
            completedSteps: [],
            targetCharacterId: characterId,
            data: {},
          },
        });
      },

      updateCharacterSettingState: (state) => {
        set(prev => ({
          characterSettingState: prev.characterSettingState
            ? { ...prev.characterSettingState, ...state }
            : null,
        }));
      },

      completeCharacterSetting: async () => {
        // TODO: ì¸ë¬¼ ì„¤ì • ê²°ê³¼ë¡œ ìºë¦­í„° ì¹´ë“œ ìƒì„±/ì—…ë°ì´íŠ¸
        set({ characterSettingState: null });
      },

      getSessionsByProject: (projectId) => {
        return Array.from(get().sessions.values())
          .filter(s => s.projectId === projectId)
          .sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());
      },

      isOverUsageLimit: () => {
        const { todayUsage, usageLimits } = get();

        if (usageLimits.dailyTokenLimit && todayUsage.tokens >= usageLimits.dailyTokenLimit) {
          return true;
        }
        if (usageLimits.dailyCostLimit && todayUsage.cost >= usageLimits.dailyCostLimit) {
          return true;
        }

        return false;
      },
    }),
    {
      name: 'storyforge-ai',
      partialize: (state) => ({
        config: state.config,
        usageLimits: state.usageLimits,
        // sessionsëŠ” IndexedDBë¡œ ì´ë™ ì˜ˆì •
      }),
    }
  )
);

// í—¬í¼ í•¨ìˆ˜ë“¤

function getSessionTitle(type: ConversationType): string {
  const titles: Record<ConversationType, string> = {
    general: 'ìƒˆ ëŒ€í™”',
    plot_setting: 'ì¤„ê±°ë¦¬ ì„¤ì •',
    character_setting: 'ì¸ë¬¼ ì„¤ì •',
    writing_assist: 'ê¸€ì“°ê¸° ë³´ì¡°',
    world_building: 'ì„¸ê³„ê´€ êµ¬ì¶•',
  };
  return titles[type];
}

function getSystemPromptForType(
  type: ConversationType,
  context: any
): string {
  const contextPrompt = formatContextAsSystemPrompt(context);

  const basePrompts: Record<ConversationType, string> = {
    general: `ë‹¹ì‹ ì€ í•œêµ­ ì›¹ì†Œì„¤ ì‘ê°€ë¥¼ ë•ëŠ” AI ë³´ì¡°ì‘ê°€ì…ë‹ˆë‹¤.
ì‘ê°€ì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
ì°½ì‘ì— ë„ì›€ì´ ë˜ëŠ” ì œì•ˆì„ ì ê·¹ì ìœ¼ë¡œ í•´ì£¼ì„¸ìš”.`,

    plot_setting: `ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì¤„ê±°ë¦¬ ì„¤ì •ì„ ë•ëŠ” ì „ë¬¸ ìŠ¤í† ë¦¬í…”ëŸ¬ì…ë‹ˆë‹¤.
ì¥ë¥´ì˜ íŠ¹ì„±ì„ ì˜ ì´í•´í•˜ê³ , í•œêµ­ ì›¹ì†Œì„¤ ë…ìë“¤ì´ ì¢‹ì•„í•˜ëŠ” ìš”ì†Œë¥¼ ë°˜ì˜í•˜ì„¸ìš”.
ë‹¨ê³„ë³„ë¡œ ì§ˆë¬¸í•˜ë©° ì‘ê°€ê°€ ì›í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ êµ¬ì²´í™”í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.`,

    character_setting: `ë‹¹ì‹ ì€ ë§¤ë ¥ì ì¸ ìºë¦­í„° ì°½ì¡°ë¥¼ ë•ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì…ì²´ì ì´ê³  ì¼ê´€ì„± ìˆëŠ” ì¸ë¬¼ì„ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
ë‹¨ê³„ë³„ë¡œ ì§ˆë¬¸í•˜ë©° ìºë¦­í„°ì˜ ì„¸ë¶€ ì‚¬í•­ì„ êµ¬ì²´í™”í•˜ì„¸ìš”.`,

    writing_assist: `ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì§‘í•„ì„ ë•ëŠ” AI ì‘ê°€ ë³´ì¡°ì…ë‹ˆë‹¤.
ì‘ê°€ì˜ ë¬¸ì²´ì™€ í†¤ì„ ì¡´ì¤‘í•˜ë©´ì„œ ë„ì›€ì„ ì œê³µí•˜ì„¸ìš”.
êµ¬ì²´ì ì¸ ë¬¸ì¥ì´ë‚˜ í‘œí˜„ì„ ì œì•ˆí•  ë•ŒëŠ” ì—¬ëŸ¬ ì˜µì…˜ì„ ì œì‹œí•˜ì„¸ìš”.`,

    world_building: `ë‹¹ì‹ ì€ ì„¸ê³„ê´€ êµ¬ì¶• ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì¼ê´€ì„± ìˆê³  ëª°ì…ê° ìˆëŠ” ì„¸ê³„ê´€ì„ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
ì„¤ì •ì˜ ë…¼ë¦¬ì  ì¼ê´€ì„±ì„ ê²€í† í•˜ê³  ë¹ˆí‹ˆì„ ì±„ì›Œì£¼ì„¸ìš”.`,
  };

  return `${basePrompts[type]}

${contextPrompt}`;
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] AI ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ
- [ ] ì„¸ì…˜ ìƒì„±/ë¡œë“œ/ì‚­ì œ ë™ì‘
- [ ] ë©”ì‹œì§€ ì „ì†¡ ë° ìŠ¤íŠ¸ë¦¬ë° ë™ì‘
- [ ] ì‚¬ìš©ëŸ‰ ì¶”ì  ë™ì‘
- [ ] TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ ì—†ìŒ

---

## Week 2: AI ëŒ€í™” UI

---

### TASK-P2-05: AI ëŒ€í™”ì°½ UI êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
ìš°ì¸¡ íŒ¨ë„ì— AI ëŒ€í™”ì°½ UIë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ê¸°ì¡´ "Coming Soon" í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ëŒ€í™” ì¸í„°í˜ì´ìŠ¤ë¡œ êµì²´í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-04

**ì‚°ì¶œë¬¼**:
- `src/components/ai/ChatPanel.tsx`
- `src/components/ai/ChatInput.tsx`
- `src/components/ai/index.ts`
- `src/components/layout/RightPanel.tsx` (ì—…ë°ì´íŠ¸)

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * ChatPanel.tsx
 *
 * AI ëŒ€í™”ì°½ ë©”ì¸ ì»´í¬ë„ŒíŠ¸
 *
 * êµ¬ì¡°:
 * - í—¤ë” (ì„¸ì…˜ íƒ€ì…, ëª¨ë¸ ì„ íƒ, ì„¤ì •)
 * - ë©”ì‹œì§€ ëª©ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­)
 * - ì…ë ¥ ì˜ì—­ (í•˜ë‹¨ ê³ ì •)
 */

import { useEffect, useRef } from 'react';
import { useAIStore } from '@/stores';
import { useProjectStore } from '@/stores';
import { ChatInput } from './ChatInput';
import { ChatMessage } from './ChatMessage';
import { ChatHeader } from './ChatHeader';
import { EmptyChat } from './EmptyChat';
import { cn } from '@/lib/cn';

export function ChatPanel() {
  const {
    currentSession,
    isGenerating,
    streamingContent,
    apiKeySet,
  } = useAIStore();
  const currentProject = useProjectStore(state => state.getCurrentProject());
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // ìƒˆ ë©”ì‹œì§€ì‹œ ìŠ¤í¬ë¡¤
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [currentSession?.messages.length, streamingContent]);

  if (!apiKeySet) {
    return <APIKeySetup />;
  }

  if (!currentProject) {
    return <NoProjectSelected />;
  }

  return (
    <div className="flex flex-col h-full">
      <ChatHeader />

      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {!currentSession || currentSession.messages.length === 0 ? (
          <EmptyChat />
        ) : (
          <>
            {currentSession.messages.map((message, index) => (
              <ChatMessage
                key={message.id}
                message={message}
                isStreaming={
                  index === currentSession.messages.length - 1 &&
                  message.status === 'streaming'
                }
                streamingContent={
                  index === currentSession.messages.length - 1
                    ? streamingContent
                    : undefined
                }
              />
            ))}
            <div ref={messagesEndRef} />
          </>
        )}
      </div>

      <ChatInput
        disabled={isGenerating || !currentProject}
        onSend={(content) => {
          const { sendMessage, currentSession, createSession } = useAIStore.getState();
          const projectId = currentProject.id;

          // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒì„±
          if (!currentSession) {
            createSession(projectId, 'general').then(() => {
              sendMessage(content, projectId);
            });
          } else {
            sendMessage(content, projectId);
          }
        }}
      />
    </div>
  );
}

function APIKeySetup() {
  // API í‚¤ ì„¤ì • UI
  return (
    <div className="flex flex-col items-center justify-center h-full p-6 text-center">
      <div className="text-4xl mb-4">ğŸ”‘</div>
      <h3 className="text-lg font-medium mb-2">API í‚¤ ì„¤ì • í•„ìš”</h3>
      <p className="text-sm text-muted-foreground mb-4">
        AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.
      </p>
      <button
        className="px-4 py-2 bg-primary text-primary-foreground rounded-md"
        onClick={() => {
          // TODO: API í‚¤ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        }}
      >
        API í‚¤ ì„¤ì •í•˜ê¸°
      </button>
    </div>
  );
}

function NoProjectSelected() {
  return (
    <div className="flex flex-col items-center justify-center h-full p-6 text-center">
      <div className="text-4xl mb-4">ğŸ“</div>
      <h3 className="text-lg font-medium mb-2">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
      <p className="text-sm text-muted-foreground">
        AI ë³´ì¡°ì‘ê°€ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.
      </p>
    </div>
  );
}
```

```typescript
/**
 * ChatInput.tsx
 *
 * ë©”ì‹œì§€ ì…ë ¥ ì»´í¬ë„ŒíŠ¸
 *
 * ê¸°ëŠ¥:
 * - í…ìŠ¤íŠ¸ ì…ë ¥ (ìë™ ë†’ì´ ì¡°ì ˆ)
 * - Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ
 * - ì „ì†¡ ë²„íŠ¼
 * - ìƒì„± ì¤‘ ì·¨ì†Œ ë²„íŠ¼
 */

import { useState, useRef, KeyboardEvent } from 'react';
import { Send, Square } from 'lucide-react';
import { useAIStore } from '@/stores';
import { cn } from '@/lib/cn';

interface ChatInputProps {
  disabled?: boolean;
  onSend: (content: string) => void;
}

export function ChatInput({ disabled, onSend }: ChatInputProps) {
  const [value, setValue] = useState('');
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const { isGenerating, cancelGeneration } = useAIStore();

  const handleSend = () => {
    if (!value.trim() || disabled) return;
    onSend(value.trim());
    setValue('');

    // ë†’ì´ ë¦¬ì…‹
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
    }
  };

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const handleInput = () => {
    const textarea = textareaRef.current;
    if (textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = `${Math.min(textarea.scrollHeight, 200)}px`;
    }
  };

  return (
    <div className="border-t border-border p-4">
      <div className="flex items-end gap-2">
        <textarea
          ref={textareaRef}
          value={value}
          onChange={(e) => setValue(e.target.value)}
          onKeyDown={handleKeyDown}
          onInput={handleInput}
          placeholder={isGenerating ? 'AIê°€ ì‘ë‹µ ì¤‘...' : 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...'}
          disabled={disabled || isGenerating}
          rows={1}
          className={cn(
            'flex-1 resize-none rounded-md border border-input bg-background px-3 py-2',
            'focus:outline-none focus:ring-2 focus:ring-ring',
            'disabled:cursor-not-allowed disabled:opacity-50',
            'min-h-[40px] max-h-[200px]'
          )}
        />

        {isGenerating ? (
          <button
            onClick={cancelGeneration}
            className="p-2 rounded-md bg-destructive text-destructive-foreground hover:bg-destructive/90"
            title="ìƒì„± ì¤‘ì§€"
          >
            <Square className="w-5 h-5" />
          </button>
        ) : (
          <button
            onClick={handleSend}
            disabled={!value.trim() || disabled}
            className={cn(
              'p-2 rounded-md',
              'bg-primary text-primary-foreground',
              'hover:bg-primary/90',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
            title="ì „ì†¡"
          >
            <Send className="w-5 h-5" />
          </button>
        )}
      </div>

      <p className="text-xs text-muted-foreground mt-2">
        Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ
      </p>
    </div>
  );
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] ëŒ€í™”ì°½ UI ì •ìƒ í‘œì‹œ
- [ ] ë©”ì‹œì§€ ì…ë ¥ ë° ì „ì†¡ ë™ì‘
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì‹¤ì‹œê°„ í‘œì‹œ
- [ ] ìŠ¤í¬ë¡¤ ë™ì‘ ì •ìƒ
- [ ] API í‚¤ ë¯¸ì„¤ì •ì‹œ ì•ˆë‚´ í‘œì‹œ

---

### TASK-P2-06: ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
ëŒ€í™” ë©”ì‹œì§€ë¥¼ ë Œë”ë§í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ì‚¬ìš©ì/AI ë©”ì‹œì§€ êµ¬ë¶„, ë§ˆí¬ë‹¤ìš´ ë Œë”ë§, ì•¡ì…˜ ë²„íŠ¼ ë“±ì„ í¬í•¨í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-05

**ì‚°ì¶œë¬¼**:
- `src/components/ai/ChatMessage.tsx`
- `src/components/ai/ActionButton.tsx`
- `src/components/ai/TypingIndicator.tsx`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * ChatMessage.tsx
 *
 * ê°œë³„ ë©”ì‹œì§€ ë Œë”ë§
 *
 * ê¸°ëŠ¥:
 * - ì‚¬ìš©ì/AI ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ êµ¬ë¶„
 * - ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (ì½”ë“œ ë¸”ë¡, ë¦¬ìŠ¤íŠ¸ ë“±)
 * - ìŠ¤íŠ¸ë¦¬ë° ì¤‘ íƒ€ì´í•‘ íš¨ê³¼
 * - AI ì œì•ˆ ì•¡ì…˜ ë²„íŠ¼
 * - ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
 */

import { memo } from 'react';
import { User, Bot, AlertCircle } from 'lucide-react';
import type { ChatMessage as ChatMessageType } from '@/types';
import { ActionButton } from './ActionButton';
import { TypingIndicator } from './TypingIndicator';
import { cn } from '@/lib/cn';
import { formatRelativeTime } from '@/lib/dateUtils';

interface ChatMessageProps {
  message: ChatMessageType;
  isStreaming?: boolean;
  streamingContent?: string;
}

export const ChatMessage = memo(function ChatMessage({
  message,
  isStreaming,
  streamingContent,
}: ChatMessageProps) {
  const isUser = message.role === 'user';
  const isError = message.status === 'error';

  const content = isStreaming ? streamingContent || '' : message.content;

  return (
    <div
      className={cn(
        'flex gap-3',
        isUser ? 'flex-row-reverse' : 'flex-row'
      )}
    >
      {/* ì•„ë°”íƒ€ */}
      <div
        className={cn(
          'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center',
          isUser ? 'bg-primary' : 'bg-secondary'
        )}
      >
        {isUser ? (
          <User className="w-4 h-4 text-primary-foreground" />
        ) : (
          <Bot className="w-4 h-4 text-secondary-foreground" />
        )}
      </div>

      {/* ë©”ì‹œì§€ ë²„ë¸” */}
      <div
        className={cn(
          'flex-1 max-w-[80%]',
          isUser ? 'text-right' : 'text-left'
        )}
      >
        <div
          className={cn(
            'inline-block rounded-lg px-4 py-2 text-sm',
            isUser
              ? 'bg-primary text-primary-foreground'
              : 'bg-secondary text-secondary-foreground',
            isError && 'bg-destructive/10 border border-destructive'
          )}
        >
          {isError && (
            <div className="flex items-center gap-2 text-destructive mb-2">
              <AlertCircle className="w-4 h-4" />
              <span>ì˜¤ë¥˜ ë°œìƒ</span>
            </div>
          )}

          {/* ë©”ì‹œì§€ ë‚´ìš© */}
          <div className="whitespace-pre-wrap">
            {content || (isStreaming && <TypingIndicator />)}
          </div>

          {/* ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì»¤ì„œ */}
          {isStreaming && content && (
            <span className="inline-block w-1 h-4 bg-current animate-pulse ml-0.5" />
          )}
        </div>

        {/* íƒ€ì„ìŠ¤íƒ¬í”„ */}
        <p className="text-xs text-muted-foreground mt-1">
          {formatRelativeTime(message.timestamp)}
          {message.model && !isUser && (
            <span className="ml-2">Â· {message.model}</span>
          )}
        </p>

        {/* ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
        {!isUser && message.suggestedActions && message.suggestedActions.length > 0 && (
          <div className="flex flex-wrap gap-2 mt-2">
            {message.suggestedActions.map(action => (
              <ActionButton key={action.id} action={action} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
});
```

```typescript
/**
 * ActionButton.tsx
 *
 * AIê°€ ì œì•ˆí•œ ì•¡ì…˜ ë²„íŠ¼
 */

import { Check, Plus, FileText, User, MapPin, Package } from 'lucide-react';
import type { SuggestedAction } from '@/types';
import { cn } from '@/lib/cn';

interface ActionButtonProps {
  action: SuggestedAction;
}

const ACTION_ICONS = {
  create_character: User,
  update_character: User,
  create_location: MapPin,
  create_item: Package,
  update_synopsis: FileText,
  create_chapter_outline: FileText,
  apply_to_editor: FileText,
  save_to_notes: FileText,
};

export function ActionButton({ action }: ActionButtonProps) {
  const Icon = ACTION_ICONS[action.type] || FileText;

  const handleClick = async () => {
    if (action.applied) return;

    // TODO: ì•¡ì…˜ ì‹¤í–‰ ë¡œì§
    console.log('Execute action:', action);
  };

  return (
    <button
      onClick={handleClick}
      disabled={action.applied}
      className={cn(
        'flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs',
        'border border-border',
        'hover:bg-accent hover:text-accent-foreground',
        'disabled:opacity-50 disabled:cursor-not-allowed',
        action.applied && 'bg-green-500/10 border-green-500'
      )}
    >
      {action.applied ? (
        <Check className="w-3 h-3 text-green-500" />
      ) : (
        <Icon className="w-3 h-3" />
      )}
      <span>{action.label}</span>
    </button>
  );
}
```

```typescript
/**
 * TypingIndicator.tsx
 *
 * AI íƒ€ì´í•‘ ì¤‘ ì¸ë””ì¼€ì´í„°
 */

export function TypingIndicator() {
  return (
    <div className="flex gap-1 items-center h-5">
      <span className="w-2 h-2 bg-current rounded-full animate-bounce [animation-delay:-0.3s]" />
      <span className="w-2 h-2 bg-current rounded-full animate-bounce [animation-delay:-0.15s]" />
      <span className="w-2 h-2 bg-current rounded-full animate-bounce" />
    </div>
  );
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] ì‚¬ìš©ì/AI ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ êµ¬ë¶„ í‘œì‹œ
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì¤‘ íƒ€ì´í•‘ íš¨ê³¼ í‘œì‹œ
- [ ] ì•¡ì…˜ ë²„íŠ¼ ë Œë”ë§ ë° í´ë¦­ ë™ì‘
- [ ] ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
- [ ] TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ ì—†ìŒ

---

## Week 3: í•µì‹¬ AI ê¸°ëŠ¥

---

### TASK-P2-07: ì¤„ê±°ë¦¬ ì„¤ì • ê¸°ëŠ¥ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
AIì™€ ë‹¨ê³„ë³„ ëŒ€í™”ë¥¼ í†µí•´ ì‘í’ˆì˜ ì¤„ê±°ë¦¬ë¥¼ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì¥ë¥´ ì„ íƒë¶€í„° í™”ë³„ ì¤„ê±°ë¦¬ê¹Œì§€ ì²´ê³„ì ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-05, TASK-P2-06

**ì‚°ì¶œë¬¼**:
- `src/components/ai/PlotSettingWizard.tsx`
- `src/components/ai/PlotStepIndicator.tsx`
- `src/services/ai/plotPrompts.ts`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * plotPrompts.ts
 *
 * ì¤„ê±°ë¦¬ ì„¤ì • ë‹¨ê³„ë³„ í”„ë¡¬í”„íŠ¸
 */

import type { PlotSettingStep, PlotSettingState } from '@/types';

export const PLOT_STEP_CONFIG: Record<PlotSettingStep, {
  title: string;
  description: string;
  systemPrompt: string;
  initialMessage: string;
}> = {
  genre_selection: {
    title: 'ì¥ë¥´ ì„ íƒ',
    description: 'ì‘í’ˆì˜ ì¥ë¥´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì¥ë¥´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì¥ë¥´ë¥¼ íŒŒì•…í•˜ê³ , í•´ë‹¹ ì¥ë¥´ì˜ íŠ¹ì„±ê³¼ ë…ì ê¸°ëŒ€ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”.
ë³µìˆ˜ ì¥ë¥´ ì¡°í•©ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.`,
    initialMessage: `ì–´ë–¤ ì¥ë¥´ì˜ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?

**ì¸ê¸° ì¥ë¥´:**
- ğŸ—¡ï¸ íŒíƒ€ì§€ (ì´ì„¸ê³„, íšŒê·€, í—Œí„°ë¬¼)
- ğŸ’• ë¡œë§¨ìŠ¤ (í˜„ëŒ€, ì‚¬ê·¹, íŒíƒ€ì§€)
- ğŸ¥‹ ë¬´í˜‘
- ğŸ” ìŠ¤ë¦´ëŸ¬/ë¯¸ìŠ¤í„°ë¦¬
- ğŸš€ SF

ì—¬ëŸ¬ ì¥ë¥´ë¥¼ ì¡°í•©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤. (ì˜ˆ: íšŒê·€ + ë¡œë§¨ìŠ¤)`,
  },

  premise: {
    title: 'ê¸°ë³¸ ì „ì œ',
    description: 'ì´ì•¼ê¸°ì˜ í•µì‹¬ ì•„ì´ë””ì–´ë¥¼ ì •í•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ìŠ¤í† ë¦¬ ì»¨ì…‰ ê°œë°œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ì•„ì´ë””ì–´ë¥¼ êµ¬ì²´í™”í•˜ê³ , ë” ë§¤ë ¥ì ì¸ ì „ì œë¡œ ë°œì „ì‹œì¼œì£¼ì„¸ìš”.
ë¡œê·¸ë¼ì¸(í•œ ì¤„ ìš”ì•½)ì„ í•¨ê»˜ ì œì•ˆí•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ì“°ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?

ê°„ë‹¨í•œ ì•„ì´ë””ì–´ë¼ë„ ê´œì°®ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´:
- "í‰ë²”í•œ íšŒì‚¬ì›ì´ ë˜ì „ì´ ë‚˜íƒ€ë‚œ ì„¸ê³„ì—ì„œ ì‚´ì•„ë‚¨ëŠ” ì´ì•¼ê¸°"
- "ì¬ë²Œê°€ ë§‰ë‚´ì•„ë“¤ë¡œ íšŒê·€í•œ ì£¼ì¸ê³µ"
- "ë§ˆì™•ì„ ë¬¼ë¦¬ì¹œ ìš©ì‚¬ê°€ í‰ë²”í•˜ê²Œ ì‚´ê³  ì‹¶ì€ ì´ì•¼ê¸°"

ì–´ë–¤ ì´ì•¼ê¸°ê°€ ë§ˆìŒì— ë“œì„¸ìš”?`,
  },

  main_character: {
    title: 'ì£¼ì¸ê³µ ì„¤ì •',
    description: 'ì£¼ì¸ê³µì˜ ê¸°ë³¸ì ì¸ íŠ¹ì„±ì„ ì •í•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ìºë¦­í„° ì„¤ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì£¼ì¸ê³µì˜ í•µì‹¬ íŠ¹ì„±ì„ íŒŒì•…í•˜ê³ , ë…ìê°€ ê³µê°í•˜ê³  ì‘ì›í•  ìˆ˜ ìˆëŠ” ìºë¦­í„°ë¡œ ë°œì „ì‹œì¼œì£¼ì„¸ìš”.
ì¥ë¥´ì— ë§ëŠ” ì£¼ì¸ê³µ ìœ í˜•ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì£¼ì¸ê³µì€ ì–´ë–¤ ì‚¬ëŒì¸ê°€ìš”?

ê¸°ë³¸ì ì¸ ê²ƒë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”?
- ì´ë¦„ê³¼ ë‚˜ì´
- ì§ì—…ì´ë‚˜ ìƒí™©
- ê°€ì¥ ë‘ë“œëŸ¬ì§€ëŠ” ì„±ê²©
- ì–´ë–¤ ëª©í‘œë‚˜ ìš•ë§ì„ ê°€ì§€ê³  ìˆëŠ”ì§€`,
  },

  conflict: {
    title: 'ê°ˆë“± ìš”ì†Œ',
    description: 'ì´ì•¼ê¸°ì˜ ì£¼ìš” ê°ˆë“±ì„ ì„¤ì •í•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ í”Œë¡¯ êµ¬ì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë§¤ë ¥ì ì¸ ê°ˆë“± êµ¬ì¡°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
ë‚´ì  ê°ˆë“±ê³¼ ì™¸ì  ê°ˆë“±ì„ ê· í˜• ìˆê²Œ ì„¤ê³„í•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì£¼ì¸ê³µì´ ê·¹ë³µí•´ì•¼ í•  ê°ˆë“±ì€ ë¬´ì—‡ì¸ê°€ìš”?

ì¢‹ì€ ê°ˆë“±ì˜ ìš”ì†Œ:
- **ì™¸ì  ê°ˆë“±**: ì•…ì—­, ì¡°ì§, ìƒí™© ë“± ì™¸ë¶€ì˜ ì¥ì• ë¬¼
- **ë‚´ì  ê°ˆë“±**: ë‘ë ¤ì›€, íŠ¸ë¼ìš°ë§ˆ, ë„ë•ì  ë”œë ˆë§ˆ

ì£¼ì¸ê³µì˜ ì•ì„ ê°€ë¡œë§‰ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?`,
  },

  world_setting: {
    title: 'ì„¸ê³„ê´€',
    description: 'ì´ì•¼ê¸°ê°€ í¼ì³ì§€ëŠ” ì„¸ê³„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ì„¸ê³„ê´€ ì„¤ê³„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì¥ë¥´ì— ë§ëŠ” ì„¸ê³„ê´€ì„ êµ¬ì¶•í•˜ê³ , ì´ì•¼ê¸°ì— í•„ìš”í•œ í•µì‹¬ ì„¤ì •ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
ì¼ê´€ì„± ìˆê³  ëª°ì…ê° ìˆëŠ” ì„¸ê³„ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ì•¼ê¸°ëŠ” ì–´ë–¤ ì„¸ê³„ì—ì„œ í¼ì³ì§€ë‚˜ìš”?

ê³ ë ¤í•  ìš”ì†Œë“¤:
- ì‹œëŒ€ ë°°ê²½ (í˜„ëŒ€, ê³¼ê±°, ë¯¸ë˜, ì´ì„¸ê³„)
- íŠ¹ë³„í•œ ê·œì¹™ì´ë‚˜ ì‹œìŠ¤í…œ (ë§ˆë²•, ë˜ì „, ëŠ¥ë ¥ ë“±)
- ì‚¬íšŒ êµ¬ì¡° (êµ­ê°€, ì¡°ì§, ê³„ê¸‰ ë“±)

ì´ ì„¸ê³„ë§Œì˜ íŠ¹ë³„í•œ ì ì´ ìˆë‚˜ìš”?`,
  },

  plot_structure: {
    title: 'í”Œë¡¯ êµ¬ì¡°',
    description: 'ì´ì•¼ê¸°ì˜ ì „ì²´ì ì¸ íë¦„ì„ ì„¤ê³„í•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ìŠ¤í† ë¦¬ êµ¬ì¡° ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
3ë§‰ êµ¬ì¡° ë˜ëŠ” ê¸°ìŠ¹ì „ê²°ì— ë§ì¶° ì´ì•¼ê¸°ì˜ í° íë¦„ì„ ì„¤ê³„í•´ì£¼ì„¸ìš”.
ê° êµ¬ê°„ì˜ í•µì‹¬ ì´ë²¤íŠ¸ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ì•¼ê¸°ì˜ ì „ì²´ íë¦„ì„ ì¡ì•„ë³¼ê¹Œìš”?

**ê¸°ë³¸ êµ¬ì¡°:**
1. **ì‹œì‘(ê¸°)**: ì£¼ì¸ê³µì˜ ì¼ìƒê³¼ ì‚¬ê±´ì˜ ì‹œì‘
2. **ì „ê°œ(ìŠ¹)**: ê°ˆë“± ì‹¬í™”, ì„±ì¥ê³¼ ì‹œë ¨
3. **ì ˆì •(ì „)**: ìµœëŒ€ì˜ ìœ„ê¸°ì™€ ê²°ì „
4. **ê²°ë§(ê²°)**: í•´ê²°ê³¼ ìƒˆë¡œìš´ ì¼ìƒ

ëŒ€ëµì ì¸ íë¦„ì„ ë§ì”€í•´ì£¼ì‹œê±°ë‚˜, ì œê°€ ì œì•ˆí•´ë“œë¦´ê¹Œìš”?`,
  },

  chapter_outline: {
    title: 'í™”ë³„ ì¤„ê±°ë¦¬',
    description: 'ê° í™”ì˜ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ê³„íší•©ë‹ˆë‹¤',
    systemPrompt: `ë‹¹ì‹ ì€ ì—°ì¬ì†Œì„¤ êµ¬ì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ê° í™”ê°€ ì ì ˆí•œ ë¶„ëŸ‰ê³¼ í›„í‚¹ì„ ê°€ì§€ë„ë¡ êµ¬ì„±í•´ì£¼ì„¸ìš”.
1í™”ë‹¹ ì•½ 5000ì ê¸°ì¤€ìœ¼ë¡œ ê³„íší•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ì œ í™”ë³„ë¡œ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì •í•´ë³¼ê¹Œìš”?

ë¨¼ì € 1ê¶Œ(ì•½ 25í™”)ì˜ ì¤„ê±°ë¦¬ë¥¼ ì¡ì•„ë³´ê² ìŠµë‹ˆë‹¤.
ì£¼ìš” ì´ë²¤íŠ¸ì™€ ê° í™”ì˜ ëì„ ì–´ë–»ê²Œ ë§ˆë¬´ë¦¬í• ì§€(í›„í‚¹) í•¨ê»˜ ìƒê°í•´ë´ìš”.

1í™”ëŠ” ì–´ë–»ê²Œ ì‹œì‘í•˜ë©´ ì¢‹ì„ê¹Œìš”?`,
  },

  review: {
    title: 'ê²€í†  ë° í™•ì •',
    description: 'ì„¤ì •ì„ ìµœì¢… í™•ì¸í•©ë‹ˆë‹¤',
    systemPrompt: `ì§€ê¸ˆê¹Œì§€ ì„¤ì •í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ì„œ ë³´ì—¬ì£¼ì„¸ìš”.
ìˆ˜ì •ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ìµœì¢… í™•ì •í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì§€ê¸ˆê¹Œì§€ ì„¤ì •í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ë“œë¦´ê²Œìš”. í™•ì¸ í›„ ìˆ˜ì •í•˜ê±°ë‚˜ í™•ì •í•´ì£¼ì„¸ìš”.`,
  },
};

export function getPlotStepPrompt(
  step: PlotSettingStep,
  state: PlotSettingState
): { system: string; initial: string } {
  const config = PLOT_STEP_CONFIG[step];

  // ì´ì „ ë‹¨ê³„ ì •ë³´ë¥¼ ë§¥ë½ì— ì¶”ê°€
  let contextAddition = '';
  if (state.data.genre) {
    contextAddition += `\n\n[ì„ íƒëœ ì¥ë¥´: ${state.data.genre.join(', ')}]`;
  }
  if (state.data.premise) {
    contextAddition += `\n[ì „ì œ: ${state.data.premise}]`;
  }
  // ... ê¸°íƒ€ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€

  return {
    system: config.systemPrompt + contextAddition,
    initial: config.initialMessage,
  };
}
```

```typescript
/**
 * PlotSettingWizard.tsx
 *
 * ì¤„ê±°ë¦¬ ì„¤ì • ë§ˆë²•ì‚¬ ì»´í¬ë„ŒíŠ¸
 */

import { useEffect } from 'react';
import { useAIStore, useProjectStore } from '@/stores';
import { PlotStepIndicator } from './PlotStepIndicator';
import { ChatPanel } from './ChatPanel';
import { PLOT_STEP_CONFIG, getPlotStepPrompt } from '@/services/ai/plotPrompts';
import type { PlotSettingStep } from '@/types';

const STEPS: PlotSettingStep[] = [
  'genre_selection',
  'premise',
  'main_character',
  'conflict',
  'world_setting',
  'plot_structure',
  'chapter_outline',
  'review',
];

export function PlotSettingWizard() {
  const currentProject = useProjectStore(state => state.getCurrentProject());
  const {
    plotSettingState,
    updatePlotSettingState,
    createSession,
    sendMessage,
  } = useAIStore();

  const currentStep = plotSettingState?.currentStep || 'genre_selection';
  const currentStepIndex = STEPS.indexOf(currentStep);

  // ë‹¨ê³„ ì‹œì‘ì‹œ ì´ˆê¸° ë©”ì‹œì§€ ì „ì†¡
  useEffect(() => {
    if (!currentProject || !plotSettingState) return;

    const { initial } = getPlotStepPrompt(currentStep, plotSettingState);

    // ì„¸ì…˜ ìƒì„± ë° ì´ˆê¸° ë©”ì‹œì§€ ì „ì†¡
    createSession(currentProject.id, 'plot_setting').then(() => {
      // AIê°€ ë¨¼ì € ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” í˜•íƒœë¡œ ì‹œì‘
    });
  }, [currentStep]);

  const handleNextStep = () => {
    if (currentStepIndex < STEPS.length - 1) {
      const nextStep = STEPS[currentStepIndex + 1];
      updatePlotSettingState({
        currentStep: nextStep,
        completedSteps: [...(plotSettingState?.completedSteps || []), currentStep],
      });
    }
  };

  const handlePrevStep = () => {
    if (currentStepIndex > 0) {
      const prevStep = STEPS[currentStepIndex - 1];
      updatePlotSettingState({ currentStep: prevStep });
    }
  };

  return (
    <div className="flex flex-col h-full">
      {/* ë‹¨ê³„ í‘œì‹œ */}
      <PlotStepIndicator
        steps={STEPS}
        currentStep={currentStep}
        completedSteps={plotSettingState?.completedSteps || []}
      />

      {/* ëŒ€í™” ì˜ì—­ */}
      <div className="flex-1 overflow-hidden">
        <ChatPanel />
      </div>

      {/* ë„¤ë¹„ê²Œì´ì…˜ */}
      <div className="flex justify-between p-4 border-t border-border">
        <button
          onClick={handlePrevStep}
          disabled={currentStepIndex === 0}
          className="px-4 py-2 text-sm border border-border rounded-md disabled:opacity-50"
        >
          ì´ì „ ë‹¨ê³„
        </button>

        {currentStep === 'review' ? (
          <button
            onClick={() => {
              // TODO: ì„¤ì • ì €ì¥ ë° ì™„ë£Œ
            }}
            className="px-4 py-2 text-sm bg-primary text-primary-foreground rounded-md"
          >
            ì„¤ì • ì™„ë£Œ
          </button>
        ) : (
          <button
            onClick={handleNextStep}
            className="px-4 py-2 text-sm bg-primary text-primary-foreground rounded-md"
          >
            ë‹¤ìŒ ë‹¨ê³„
          </button>
        )}
      </div>
    </div>
  );
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] 8ë‹¨ê³„ ì¤„ê±°ë¦¬ ì„¤ì • í”Œë¡œìš° ë™ì‘
- [ ] ê° ë‹¨ê³„ë³„ í”„ë¡¬í”„íŠ¸ ì ìš©
- [ ] ì´ì „ ë‹¨ê³„ ì •ë³´ê°€ ë‹¤ìŒ ë‹¨ê³„ì— ì „ë‹¬
- [ ] ìµœì¢… ì„¤ì • ì €ì¥ ê°€ëŠ¥
- [ ] ë‹¨ê³„ í‘œì‹œ UI ì •ìƒ ë™ì‘

---

### TASK-P2-08: ì¸ë¬¼ ì„¤ì • ê¸°ëŠ¥ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
AIì™€ ë‹¨ê³„ë³„ ëŒ€í™”ë¥¼ í†µí•´ ì¸ë¬¼ì„ ì„¤ì •í•˜ê³ , ì™„ë£Œì‹œ ìºë¦­í„° ì¹´ë“œë¥¼ ìë™ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-07

**ì‚°ì¶œë¬¼**:
- `src/components/ai/CharacterSettingWizard.tsx`
- `src/services/ai/characterPrompts.ts`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * characterPrompts.ts
 *
 * ì¸ë¬¼ ì„¤ì • ë‹¨ê³„ë³„ í”„ë¡¬í”„íŠ¸
 */

import type { CharacterSettingStep, CharacterSettingState } from '@/types';

export const CHARACTER_STEP_CONFIG: Record<CharacterSettingStep, {
  title: string;
  description: string;
  systemPrompt: string;
  initialMessage: string;
}> = {
  basic_info: {
    title: 'ê¸°ë³¸ ì •ë³´',
    description: 'ì´ë¦„, ë‚˜ì´, ì§ì—… ë“±',
    systemPrompt: `ë‹¹ì‹ ì€ ìºë¦­í„° ì„¤ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ìºë¦­í„°ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”.
í•œêµ­ ì›¹ì†Œì„¤ì— ì–´ìš¸ë¦¬ëŠ” ì´ë¦„ì„ ì œì•ˆí•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    initialMessage: `ìƒˆë¡œìš´ ì¸ë¬¼ì„ ë§Œë“¤ì–´ë³¼ê¹Œìš”?

ë¨¼ì € ê¸°ë³¸ì ì¸ ì •ë³´ë¶€í„° ì •í•´ë´ìš”:
- ì´ë¦„ (ì‘ëª…ì´ ì–´ë ¤ìš°ì‹œë©´ ë„ì™€ë“œë¦´ê²Œìš”!)
- ë‚˜ì´ ë˜ëŠ” ì—°ë ¹ëŒ€
- ì´ ì¸ë¬¼ì˜ ì—­í•  (ì£¼ì¸ê³µ, ì¡°ì—°, ì•…ì—­ ë“±)
- ì§ì—…ì´ë‚˜ ì‹ ë¶„`,
  },

  appearance: {
    title: 'ì™¸ëª¨',
    description: 'ì‹ ì²´ì  íŠ¹ì§•',
    systemPrompt: `ìºë¦­í„°ì˜ ì™¸ëª¨ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.
ë…ìê°€ ì‰½ê²Œ ìƒìƒí•  ìˆ˜ ìˆë„ë¡ íŠ¹ì§•ì ì¸ ë¶€ë¶„ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ ì¸ë¬¼ì˜ ì™¸ëª¨ëŠ” ì–´ë–¤ê°€ìš”?

ë¬˜ì‚¬í•  ìˆ˜ ìˆëŠ” ìš”ì†Œë“¤:
- ì „ì²´ì ì¸ ì¸ìƒ (ì˜ˆ: ì°¨ê°€ìš´, ë”°ëœ»í•œ, ë‚ ì¹´ë¡œìš´)
- ì²´í˜•ê³¼ í‚¤
- ë¨¸ë¦¬ì¹´ë½, ëˆˆë™ì ìƒ‰
- íŠ¹ì§•ì ì¸ ë¶€ë¶„ (í‰í„°, ì , ìŠµê´€ì ì¸ í‘œì • ë“±)`,
  },

  personality: {
    title: 'ì„±ê²©',
    description: 'ì„±ê²© íŠ¹ì„±',
    systemPrompt: `ìºë¦­í„°ì˜ ì„±ê²©ì„ ë‹¤ë©´ì ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.
ê²‰ìœ¼ë¡œ ë³´ì´ëŠ” ëª¨ìŠµê³¼ ë‚´ë©´ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    initialMessage: `ì´ ì¸ë¬¼ì˜ ì„±ê²©ì„ ì•Œë ¤ì£¼ì„¸ìš”.

ìƒê°í•´ë³¼ ì ë“¤:
- ì²«ì¸ìƒ (ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€)
- ì‹¤ì œ ì„±ê²© (ì¹œí•´ì§„ í›„ì— ë³´ì´ëŠ” ëª¨ìŠµ)
- ì¥ì ê³¼ ë‹¨ì 
- íŠ¹ì´í•œ ë²„ë¦‡ì´ë‚˜ ìŠµê´€`,
  },

  background: {
    title: 'ë°°ê²½',
    description: 'ê³¼ê±°ì™€ ì„±ì¥ í™˜ê²½',
    systemPrompt: `ìºë¦­í„°ì˜ ê³¼ê±°ì™€ ë°°ê²½ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.
í˜„ì¬ ì„±ê²©ì„ í˜•ì„±í•˜ê²Œ ëœ ê²½í—˜ì„ í¬í•¨í•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ ì¸ë¬¼ì€ ì–´ë–¤ ì‚¶ì„ ì‚´ì•„ì™”ë‚˜ìš”?

ë°°ê²½ ì´ì•¼ê¸°:
- ê°€ì¡± ê´€ê³„
- ì„±ì¥ í™˜ê²½
- ì¸ìƒì— í° ì˜í–¥ì„ ì¤€ ì‚¬ê±´
- ë¹„ë°€ì´ë‚˜ íŠ¸ë¼ìš°ë§ˆ (ìˆë‹¤ë©´)`,
  },

  motivation: {
    title: 'ë™ê¸°',
    description: 'ëª©í‘œì™€ ìš•ë§',
    systemPrompt: `ìºë¦­í„°ì˜ ë™ê¸°ì™€ ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
ì´ì•¼ê¸°ë¥¼ ì´ë„ëŠ” ì›ë™ë ¥ì´ ë©ë‹ˆë‹¤.`,
    initialMessage: `ì´ ì¸ë¬¼ì´ ê°€ì¥ ì›í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?

ë™ê¸° ìš”ì†Œ:
- ê°€ì¥ í° ëª©í‘œ (ë¬´ì—‡ì„ ì´ë£¨ê³  ì‹¶ì€ì§€)
- ì™œ ê·¸ê²ƒì„ ì›í•˜ëŠ”ì§€
- ëª©í‘œë¥¼ ìœ„í•´ ì–´ë””ê¹Œì§€ í•  ìˆ˜ ìˆëŠ”ì§€
- ë‘ë ¤ì›Œí•˜ëŠ” ê²ƒ`,
  },

  relationships: {
    title: 'ê´€ê³„',
    description: 'ë‹¤ë¥¸ ì¸ë¬¼ê³¼ì˜ ê´€ê³„',
    systemPrompt: `ë‹¤ë¥¸ ìºë¦­í„°ì™€ì˜ ê´€ê³„ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
ê¸°ì¡´ ìºë¦­í„°ì™€ì˜ ì—°ê²°ê³ ë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`,
    initialMessage: `ë‹¤ë¥¸ ì¸ë¬¼ë“¤ê³¼ ì–´ë–¤ ê´€ê³„ì¸ê°€ìš”?

ì£¼ìš” ê´€ê³„:
- ê°€ì¡±
- ì¹œêµ¬ ë˜ëŠ” ë™ë£Œ
- ì  ë˜ëŠ” ë¼ì´ë²Œ
- íŠ¹ë³„í•œ ê´€ê³„ (ì—°ì¸, ìŠ¤ìŠ¹ ë“±)

ê¸°ì¡´ ë“±ì¥ì¸ë¬¼ê³¼ì˜ ê´€ê³„ë„ ì„¤ì •í•  ìˆ˜ ìˆì–´ìš”.`,
  },

  abilities: {
    title: 'ëŠ¥ë ¥',
    description: 'íŠ¹ê¸°ì™€ ëŠ¥ë ¥ (ì¥ë¥´ì— ë”°ë¼)',
    systemPrompt: `ìºë¦­í„°ì˜ ëŠ¥ë ¥ì´ë‚˜ íŠ¹ê¸°ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
ì¥ë¥´ì— ë§ëŠ” ëŠ¥ë ¥ì„ ì œì•ˆí•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    initialMessage: `ì´ ì¸ë¬¼ì˜ ëŠ¥ë ¥ì´ë‚˜ íŠ¹ê¸°ê°€ ìˆë‚˜ìš”?

(íŒíƒ€ì§€/ë¬´í˜‘/ëŠ¥ë ¥ë¬¼ì˜ ê²½ìš°)
- ê°€ì§„ ëŠ¥ë ¥ì´ë‚˜ ìŠ¤í‚¬
- ëŠ¥ë ¥ì˜ ê°•ì ê³¼ ì•½ì 
- ì„±ì¥ ê°€ëŠ¥ì„±

(ì¼ë°˜ ì¥ë¥´ì˜ ê²½ìš°)
- ì „ë¬¸ ë¶„ì•¼ë‚˜ íŠ¹ê¸°
- ë‚¨ë‹¤ë¥¸ ì¬ëŠ¥`,
  },

  arc: {
    title: 'ì„±ì¥ ê³¡ì„ ',
    description: 'ìºë¦­í„°ì˜ ë³€í™”',
    systemPrompt: `ìºë¦­í„°ì˜ ì„±ì¥ê³¼ ë³€í™”ë¥¼ ì„¤ê³„í•´ì£¼ì„¸ìš”.
ì´ì•¼ê¸° ì§„í–‰ì— ë”°ë¥¸ ë°œì „ì„ ê³„íší•´ì£¼ì„¸ìš”.`,
    initialMessage: `ì´ ì¸ë¬¼ì€ ì´ì•¼ê¸° ì†ì—ì„œ ì–´ë–»ê²Œ ë³€í™”í•˜ë‚˜ìš”?

ìºë¦­í„° ì•„í¬:
- ì‹œì‘ì  (ì²˜ìŒì—ëŠ” ì–´ë–¤ ëª¨ìŠµì¸ì§€)
- ê²ªê²Œ ë  ì‹œë ¨
- ëì  (ìµœì¢…ì ìœ¼ë¡œ ì–´ë–¤ ëª¨ìŠµì´ ë˜ëŠ”ì§€)
- ë³€í™”ì˜ ê³„ê¸°ê°€ ë  ì‚¬ê±´`,
  },

  review: {
    title: 'ê²€í† ',
    description: 'ì„¤ì • í™•ì¸ ë° ì™„ë£Œ',
    systemPrompt: `ì§€ê¸ˆê¹Œì§€ ì„¤ì •í•œ ìºë¦­í„° ì •ë³´ë¥¼ ì •ë¦¬í•´ì„œ ë³´ì—¬ì£¼ì„¸ìš”.
ìºë¦­í„° ì¹´ë“œ í˜•ì‹ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.`,
    initialMessage: `ìºë¦­í„° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`,
  },
};

/**
 * ìºë¦­í„° ì„¤ì • ì™„ë£Œ í›„ ì¹´ë“œ ë°ì´í„° ìƒì„±
 */
export function buildCharacterCardFromState(
  state: CharacterSettingState
): Partial<import('@/types').CharacterCard> {
  const { data } = state;

  return {
    type: 'character',
    name: data.name || 'ì´ë¦„ ì—†ìŒ',
    description: data.background || '',
    role: (data.role as any) || 'supporting',
    basicInfo: {
      age: data.age,
      gender: data.gender,
      occupation: data.occupation,
    },
    appearance: {
      distinguishingFeatures: data.appearance,
    },
    personality: data.personality || '',
    background: data.background || '',
    motivation: data.motivation || '',
    abilities: data.abilities || [],
    relationships: data.relationships?.map(r => ({
      targetId: '', // ë‚˜ì¤‘ì— ë§¤ì¹­
      targetName: r.targetName,
      relationType: r.type,
      description: r.description,
    })) || [],
    arc: data.arc || [],
    tags: [],
  };
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] 9ë‹¨ê³„ ì¸ë¬¼ ì„¤ì • í”Œë¡œìš° ë™ì‘
- [ ] ì„¤ì • ì™„ë£Œì‹œ ìºë¦­í„° ì¹´ë“œ ìë™ ìƒì„±
- [ ] ê¸°ì¡´ ìºë¦­í„° ìˆ˜ì • ëª¨ë“œ ì§€ì›
- [ ] ë‹¤ë¥¸ ìºë¦­í„°ì™€ ê´€ê³„ ì—°ê²° ê°€ëŠ¥

---

### TASK-P2-09: ì‹¤ì‹œê°„ ìš”ì•½ íŒ¨ë„ êµ¬í˜„

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì§„í–‰ìƒí™©, ë“±ì¥ì¸ë¬¼ ìƒíƒœ, ìµœê·¼ ìš”ì•½ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œí•˜ëŠ” íŒ¨ë„ì„ êµ¬í˜„í•©ë‹ˆë‹¤. AIê°€ ë§¥ë½ì„ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-04

**ì‚°ì¶œë¬¼**:
- `src/components/ai/RealtimeSummaryPanel.tsx`
- `src/components/ai/CharacterStateCard.tsx`
- `src/services/ai/summaryService.ts`

#### êµ¬í˜„ ìš”êµ¬ì‚¬í•­

```typescript
/**
 * summaryService.ts
 *
 * ì‹¤ì‹œê°„ ìš”ì•½ ìƒì„± ì„œë¹„ìŠ¤
 */

import { db } from '@/db';
import type { RealtimeSummary } from '@/types';

/**
 * í”„ë¡œì íŠ¸ì˜ ì‹¤ì‹œê°„ ìš”ì•½ ìƒì„±
 */
export async function generateRealtimeSummary(
  projectId: string
): Promise<RealtimeSummary> {
  // í”„ë¡œì íŠ¸ ì •ë³´
  const project = await db.projects.get(projectId);
  if (!project) throw new Error('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  // êµ¬ì¡° ì •ë³´
  const volumes = await db.volumes.where('projectId').equals(projectId).toArray();
  const chapters = await db.chapters.where('projectId').equals(projectId).toArray();
  const scenes = await db.scenes.where('projectId').equals(projectId).toArray();

  // ì§„í–‰ë¥  ê³„ì‚°
  const completedChapters = chapters.filter(c =>
    c.status === 'complete' || c.status === 'published'
  ).length;

  // ìºë¦­í„° ìƒíƒœ (ê°„ë‹¨íˆ - ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ë¡œì§ í•„ìš”)
  const characters = await db.characters.where('projectId').equals(projectId).toArray();
  const characterStates = characters
    .filter(c => c.role !== 'minor')
    .slice(0, 5)
    .map(c => ({
      characterId: c.id,
      name: c.name,
      condition: 'í™œë™ ì¤‘', // TODO: ì‹¤ì œ ìƒíƒœ ì¶”ì 
    }));

  // ìµœê·¼ ì”¬ ìš”ì•½
  const recentScenes = scenes
    .filter(s => s.plainText.length > 0)
    .sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime())
    .slice(0, 3);

  const recentChapterSummaries = await Promise.all(
    recentScenes.map(async scene => {
      const chapter = await db.chapters.get(scene.chapterId);
      return {
        chapterTitle: chapter?.title || scene.title,
        summary: scene.plainText.slice(0, 200) + '...',
        keyEvents: [], // TODO: AIë¡œ í•µì‹¬ ì´ë²¤íŠ¸ ì¶”ì¶œ
      };
    })
  );

  return {
    progress: {
      currentVolume: volumes.length > 0 ? volumes.length : 1,
      currentChapter: completedChapters + 1,
      totalChapters: chapters.length,
      completionPercentage: chapters.length > 0
        ? Math.round((completedChapters / chapters.length) * 100)
        : 0,
    },
    characterStates,
    recentChapterSummaries,
    activeForeshadowing: [], // TODO: ë³µì„  ê´€ë¦¬ ê¸°ëŠ¥
    lastUpdatedAt: new Date(),
  };
}
```

```typescript
/**
 * RealtimeSummaryPanel.tsx
 *
 * ì‹¤ì‹œê°„ ìš”ì•½ íŒ¨ë„
 */

import { useEffect, useState } from 'react';
import { RefreshCw, Users, BookOpen, Sparkles } from 'lucide-react';
import { useProjectStore } from '@/stores';
import { generateRealtimeSummary } from '@/services/ai/summaryService';
import { CharacterStateCard } from './CharacterStateCard';
import type { RealtimeSummary } from '@/types';
import { cn } from '@/lib/cn';

export function RealtimeSummaryPanel() {
  const currentProject = useProjectStore(state => state.getCurrentProject());
  const [summary, setSummary] = useState<RealtimeSummary | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const loadSummary = async () => {
    if (!currentProject) return;

    setIsLoading(true);
    try {
      const data = await generateRealtimeSummary(currentProject.id);
      setSummary(data);
    } catch (error) {
      console.error('Failed to load summary:', error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    loadSummary();
  }, [currentProject?.id]);

  if (!currentProject) {
    return null;
  }

  return (
    <div className="flex flex-col h-full">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between p-4 border-b border-border">
        <h3 className="font-medium flex items-center gap-2">
          <Sparkles className="w-4 h-4" />
          ì‹¤ì‹œê°„ ìš”ì•½
        </h3>
        <button
          onClick={loadSummary}
          disabled={isLoading}
          className="p-1 rounded hover:bg-accent"
        >
          <RefreshCw className={cn('w-4 h-4', isLoading && 'animate-spin')} />
        </button>
      </div>

      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {/* ì§„í–‰ ìƒí™© */}
        <section>
          <h4 className="text-sm font-medium flex items-center gap-2 mb-2">
            <BookOpen className="w-4 h-4" />
            ì§„í–‰ ìƒí™©
          </h4>
          {summary && (
            <div className="bg-secondary rounded-lg p-3 space-y-2">
              <div className="flex justify-between text-sm">
                <span>í˜„ì¬ ìœ„ì¹˜</span>
                <span className="font-medium">
                  {summary.progress.currentVolume}ê¶Œ {summary.progress.currentChapter}í™”
                </span>
              </div>
              <div className="w-full bg-muted rounded-full h-2">
                <div
                  className="bg-primary h-2 rounded-full transition-all"
                  style={{ width: `${summary.progress.completionPercentage}%` }}
                />
              </div>
              <div className="text-xs text-muted-foreground text-right">
                {summary.progress.completionPercentage}% ì™„ë£Œ
              </div>
            </div>
          )}
        </section>

        {/* ë“±ì¥ì¸ë¬¼ ìƒíƒœ */}
        <section>
          <h4 className="text-sm font-medium flex items-center gap-2 mb-2">
            <Users className="w-4 h-4" />
            ë“±ì¥ì¸ë¬¼ ìƒíƒœ
          </h4>
          <div className="space-y-2">
            {summary?.characterStates.map(char => (
              <CharacterStateCard key={char.characterId} character={char} />
            ))}
          </div>
        </section>

        {/* ìµœê·¼ ë‚´ìš© */}
        <section>
          <h4 className="text-sm font-medium mb-2">ìµœê·¼ ë‚´ìš©</h4>
          <div className="space-y-2">
            {summary?.recentChapterSummaries.map((chapter, index) => (
              <div key={index} className="text-sm p-2 bg-secondary rounded">
                <p className="font-medium mb-1">{chapter.chapterTitle}</p>
                <p className="text-muted-foreground text-xs line-clamp-2">
                  {chapter.summary}
                </p>
              </div>
            ))}
          </div>
        </section>
      </div>
    </div>
  );
}
```

#### ì™„ë£Œ ì¡°ê±´

- [ ] ì§„í–‰ ìƒí™© ì‹¤ì‹œê°„ í‘œì‹œ
- [ ] ë“±ì¥ì¸ë¬¼ ìƒíƒœ í‘œì‹œ
- [ ] ìµœê·¼ ë‚´ìš© ìš”ì•½ í‘œì‹œ
- [ ] ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ë™ì‘
- [ ] AI ë§¥ë½ì—ì„œ ì°¸ì¡° ê°€ëŠ¥

---

## Week 4: ê³ ë„í™” ë° ë§ˆë¬´ë¦¬

---

### TASK-P2-10: í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì‹œìŠ¤í…œ

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
ë‹¤ì–‘í•œ ìƒí™©ì— ë§ëŠ” í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ê´€ë¦¬í•˜ê³ , ë§¥ë½ì— ë§ê²Œ ë™ì ìœ¼ë¡œ ì¡°í•©í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-03

**ì‚°ì¶œë¬¼**:
- `src/services/ai/promptTemplates.ts`
- `src/services/ai/promptBuilder.ts`

---

### TASK-P2-11: ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìµœì í™”

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì˜ ì•ˆì •ì„±ê³¼ ì„±ëŠ¥ì„ ê°œì„ í•©ë‹ˆë‹¤. ì—°ê²° ëŠê¹€ ì²˜ë¦¬, ì¬ì—°ê²° ë¡œì§, ë¶€ë¶„ ì‘ë‹µ ì €ì¥ ë“±ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-02

**ì‚°ì¶œë¬¼**:
- `src/services/ai/streamHandler.ts`
- `src/hooks/useStreamingMessage.ts`

---

### TASK-P2-12: í† í°/ë¹„ìš© ê´€ë¦¬ ì‹œìŠ¤í…œ

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
API ì‚¬ìš©ëŸ‰ê³¼ ë¹„ìš©ì„ ì¶”ì í•˜ê³ , ì œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-04

**ì‚°ì¶œë¬¼**:
- `src/components/ai/UsageStats.tsx`
- `src/components/ai/UsageLimitModal.tsx`
- `src/services/ai/usageTracker.ts`

---

### TASK-P2-13: QA ë° ìµœì í™”

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
Phase 2 ì „ì²´ ê¸°ëŠ¥ì— ëŒ€í•œ í’ˆì§ˆ ê²€ì¦ ë° ì„±ëŠ¥ ìµœì í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: ëª¨ë“  Phase 2 Task

**ì‚°ì¶œë¬¼**:
- ë²„ê·¸ ìˆ˜ì •
- ì„±ëŠ¥ ìµœì í™”
- ì‚¬ìš©ì í”¼ë“œë°± ë°˜ì˜

#### ì™„ë£Œ ì¡°ê±´

- [ ] ëª¨ë“  AI ê¸°ëŠ¥ ì •ìƒ ë™ì‘
- [ ] ì˜¤í”„ë¼ì¸ì‹œ ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬
- [ ] í† í° ì‚¬ìš©ëŸ‰ ì •í™•íˆ ì¶”ì 
- [ ] ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—†ìŒ
- [ ] ì‘ë‹µ ì‹œê°„ 3ì´ˆ ì´ë‚´

---

### TASK-P2-14: API í‚¤ ê´€ë¦¬ UI

**ì „ì²´ ë§¥ë½ì—ì„œì˜ ëª©ì **:
ì‚¬ìš©ìê°€ ìì‹ ì˜ OpenAI API í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ì„¤ì •í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” UIë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì˜ì¡´ì„±**: TASK-P2-02

**ì‚°ì¶œë¬¼**:
- `src/components/ai/APIKeyModal.tsx`
- `src/components/settings/AISettings.tsx`

---

## ë¶€ë¡

### Phase 2 ì™„ë£Œ ê¸°ì¤€

- [ ] AI ëŒ€í™”ì°½ì—ì„œ ë©”ì‹œì§€ ì£¼ê³ ë°›ê¸° ê°€ëŠ¥
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì‹¤ì‹œê°„ í‘œì‹œ
- [ ] ì¤„ê±°ë¦¬ ì„¤ì • ë§ˆë²•ì‚¬ 8ë‹¨ê³„ ì™„ë£Œ ê°€ëŠ¥
- [ ] ì¸ë¬¼ ì„¤ì • ë§ˆë²•ì‚¬ 9ë‹¨ê³„ ì™„ë£Œ â†’ ìºë¦­í„° ì¹´ë“œ ìë™ ìƒì„±
- [ ] ì‹¤ì‹œê°„ ìš”ì•½ íŒ¨ë„ í‘œì‹œ
- [ ] í† í° ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© ì¶”ì 
- [ ] ì¼ì¼ ì‚¬ìš©ëŸ‰ ì œí•œ ì„¤ì • ê°€ëŠ¥
- [ ] API í‚¤ ì—†ì„ ë•Œ ì ì ˆí•œ ì•ˆë‚´
- [ ] ì˜¤í”„ë¼ì¸ì‹œ ê¸°ì¡´ ê¸°ëŠ¥ ì •ìƒ ì‘ë™

### ì°¸ì¡° ë¬¸ì„œ

- `docs/Storyforge-PRD.md` - ì›ë³¸ ê¸°íšì„œ
- `docs/Storyforge-PRD-v2.md` - ìƒì„¸ ê°œë°œ ëª…ì„¸
- `docs/Storyforge-TaskPlan.md` - Phase 1 ì‘ì—… ëª…ì„¸

### AI ëª¨ë¸ ë¹„ìš© ì°¸ê³  (2024ë…„ ê¸°ì¤€)

| ëª¨ë¸ | Input (1K tokens) | Output (1K tokens) |
|------|-------------------|-------------------|
| GPT-4 | $0.03 | $0.06 |
| GPT-4 Turbo | $0.01 | $0.03 |
| GPT-3.5 Turbo | $0.0005 | $0.0015 |

ì˜ˆìƒ ë¹„ìš©:
- 1íšŒ ëŒ€í™” (ì•½ 2000 í† í°): GPT-3.5 ê¸°ì¤€ ì•½ $0.002
- ì¤„ê±°ë¦¬ ì„¤ì • (ì•½ 20000 í† í°): GPT-3.5 ê¸°ì¤€ ì•½ $0.02
- ì¼ì¼ ì ê·¹ ì‚¬ìš© (ì•½ 100000 í† í°): GPT-3.5 ê¸°ì¤€ ì•½ $0.10

---

*ë¬¸ì„œ ë*
